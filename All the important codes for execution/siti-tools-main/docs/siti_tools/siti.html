<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="pdoc 6.3.2" />
    <title>siti_tools.siti API documentation</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2264%22%20height%3D%2264%22%20viewBox%3D%2244.5%202.5%2015%2015%22%3E%3Cpath%20d%3D%22M49.351%2021.041c-.233-.721-.546-2.408-.772-4.076-.042-.09-.067-.187-.046-.288-.166-1.347-.277-2.625-.241-3.351-1.378-1.008-2.271-2.586-2.271-4.362%200-.976.272-1.935.788-2.774.057-.094.122-.18.184-.268-.033-.167-.052-.339-.052-.516%200-1.477%201.202-2.679%202.679-2.679.791%200%201.496.352%201.987.9a6.3%206.3%200%200%201%201.001.029c.492-.564%201.207-.929%202.012-.929%201.477%200%202.679%201.202%202.679%202.679a2.65%202.65%200%200%201-.269%201.148c.383.747.595%201.572.595%202.41%200%202.311-1.507%204.29-3.635%205.107.037.699.147%202.27.423%203.294l.137.461c.156%202.136-4.612%205.166-5.199%203.215zm.127-4.919a4.78%204.78%200%200%200%20.775-.584c-.172-.115-.505-.254-.88-.378zm.331%202.302l.828-.502c-.202-.143-.576-.328-.984-.49zm.45%202.157l.701-.403c-.214-.115-.536-.249-.891-.376l.19.779zM49.13%204.141c0%20.152.123.276.276.276s.275-.124.275-.276-.123-.276-.276-.276-.275.124-.275.276zm.735-.389a1.15%201.15%200%200%201%20.314.783%201.16%201.16%200%200%201-1.162%201.162c-.457%200-.842-.27-1.032-.653-.026.117-.042.238-.042.362a1.68%201.68%200%200%200%201.679%201.679%201.68%201.68%200%200%200%201.679-1.679c0-.843-.626-1.535-1.436-1.654zm3.076%201.654a1.68%201.68%200%200%200%201.679%201.679%201.68%201.68%200%200%200%201.679-1.679c0-.037-.009-.072-.011-.109-.21.3-.541.508-.935.508a1.16%201.16%200%200%201-1.162-1.162%201.14%201.14%200%200%201%20.474-.912c-.015%200-.03-.005-.045-.005-.926.001-1.679.754-1.679%201.68zm1.861-1.265c0%20.152.123.276.276.276s.275-.124.275-.276-.123-.276-.276-.276-.275.124-.275.276zm1.823%204.823c0-.52-.103-1.035-.288-1.52-.466.394-1.06.64-1.717.64-1.144%200-2.116-.725-2.499-1.738-.383%201.012-1.355%201.738-2.499%201.738-.867%200-1.631-.421-2.121-1.062-.307.605-.478%201.267-.478%201.942%200%202.486%202.153%204.51%204.801%204.51s4.801-2.023%204.801-4.51zm-3.032%209.156l-.146-.492c-.276-1.02-.395-2.457-.444-3.268a6.11%206.11%200%200%201-1.18.115%206.01%206.01%200%200%201-2.536-.562l.006.175c.802.215%201.848.612%202.021%201.25.079.295-.021.601-.274.837l-.598.501c.667.304%201.243.698%201.311%201.179.02.144.022.507-.393.787l-.564.365c1.285.521%201.361.96%201.381%201.126.018.142.011.496-.427.746l-.854.489c.064-1.19%201.985-2.585%202.697-3.248zM49.34%209.925c0-.667%201-.667%201%200%200%20.653.818%201.205%201.787%201.205s1.787-.552%201.787-1.205c0-.667%201-.667%201%200%200%201.216-1.25%202.205-2.787%202.205s-2.787-.989-2.787-2.205zm-.887-7.633c-.093.077-.205.114-.317.114a.5.5%200%200%201-.318-.886L49.183.397a.5.5%200%200%201%20.703.068.5.5%200%200%201-.069.703zm7.661-.065c-.086%200-.173-.022-.253-.068l-1.523-.893c-.575-.337-.069-1.2.506-.863l1.523.892a.5.5%200%200%201%20.179.685c-.094.158-.261.247-.432.247z%22%20fill%3D%22%233bb300%22/%3E%3C/svg%3E"/>


<style type="text/css">/*! * Bootstrap Reboot v5.0.0-beta1 (https://getbootstrap.com/) * Copyright 2011-2020 The Bootstrap Authors * Copyright 2011-2020 Twitter, Inc. * Licensed under MIT (https://github.com/twbs/bootstrap/blob/main/LICENSE) * Forked from Normalize.css, licensed MIT (https://github.com/necolas/normalize.css/blob/master/LICENSE.md) */*,::after,::before{box-sizing:border-box}@media (prefers-reduced-motion:no-preference){:root{scroll-behavior:smooth}}body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans","Liberation Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";font-size:1rem;font-weight:400;line-height:1.5;color:#212529;background-color:#fff;-webkit-text-size-adjust:100%;-webkit-tap-highlight-color:transparent}[tabindex="-1"]:focus:not(:focus-visible){outline:0!important}hr{margin:1rem 0;color:inherit;background-color:currentColor;border:0;opacity:.25}hr:not([size]){height:1px}h1,h2,h3,h4,h5,h6{margin-top:0;margin-bottom:.5rem;font-weight:500;line-height:1.2}h1{font-size:calc(1.375rem + 1.5vw)}@media (min-width:1200px){h1{font-size:2.5rem}}h2{font-size:calc(1.325rem + .9vw)}@media (min-width:1200px){h2{font-size:2rem}}h3{font-size:calc(1.3rem + .6vw)}@media (min-width:1200px){h3{font-size:1.75rem}}h4{font-size:calc(1.275rem + .3vw)}@media (min-width:1200px){h4{font-size:1.5rem}}h5{font-size:1.25rem}h6{font-size:1rem}p{margin-top:0;margin-bottom:1rem}abbr[data-bs-original-title],abbr[title]{text-decoration:underline;-webkit-text-decoration:underline dotted;text-decoration:underline dotted;cursor:help;-webkit-text-decoration-skip-ink:none;text-decoration-skip-ink:none}address{margin-bottom:1rem;font-style:normal;line-height:inherit}ol,ul{padding-left:2rem}dl,ol,ul{margin-top:0;margin-bottom:1rem}ol ol,ol ul,ul ol,ul ul{margin-bottom:0}dt{font-weight:700}dd{margin-bottom:.5rem;margin-left:0}blockquote{margin:0 0 1rem}b,strong{font-weight:bolder}small{font-size:.875em}mark{padding:.2em;background-color:#fcf8e3}sub,sup{position:relative;font-size:.75em;line-height:0;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}a{color:#0d6efd;text-decoration:underline}a:hover{color:#0a58ca}a:not([href]):not([class]),a:not([href]):not([class]):hover{color:inherit;text-decoration:none}code,kbd,pre,samp{font-family:SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;font-size:1em;direction:ltr;unicode-bidi:bidi-override}pre{display:block;margin-top:0;margin-bottom:1rem;overflow:auto;font-size:.875em}pre code{font-size:inherit;color:inherit;word-break:normal}code{font-size:.875em;color:#d63384;word-wrap:break-word}a>code{color:inherit}kbd{padding:.2rem .4rem;font-size:.875em;color:#fff;background-color:#212529;border-radius:.2rem}kbd kbd{padding:0;font-size:1em;font-weight:700}figure{margin:0 0 1rem}img,svg{vertical-align:middle}table{caption-side:bottom;border-collapse:collapse}caption{padding-top:.5rem;padding-bottom:.5rem;color:#6c757d;text-align:left}th{text-align:inherit;text-align:-webkit-match-parent}tbody,td,tfoot,th,thead,tr{border-color:inherit;border-style:solid;border-width:0}label{display:inline-block}button{border-radius:0}button:focus{outline:dotted 1px;outline:-webkit-focus-ring-color auto 5px}button,input,optgroup,select,textarea{margin:0;font-family:inherit;font-size:inherit;line-height:inherit}button,select{text-transform:none}[role=button]{cursor:pointer}select{word-wrap:normal}[list]::-webkit-calendar-picker-indicator{display:none}[type=button],[type=reset],[type=submit],button{-webkit-appearance:button}[type=button]:not(:disabled),[type=reset]:not(:disabled),[type=submit]:not(:disabled),button:not(:disabled){cursor:pointer}::-moz-focus-inner{padding:0;border-style:none}textarea{resize:vertical}fieldset{min-width:0;padding:0;margin:0;border:0}legend{float:left;width:100%;padding:0;margin-bottom:.5rem;font-size:calc(1.275rem + .3vw);line-height:inherit}@media (min-width:1200px){legend{font-size:1.5rem}}legend+*{clear:left}::-webkit-datetime-edit-day-field,::-webkit-datetime-edit-fields-wrapper,::-webkit-datetime-edit-hour-field,::-webkit-datetime-edit-minute,::-webkit-datetime-edit-month-field,::-webkit-datetime-edit-text,::-webkit-datetime-edit-year-field{padding:0}::-webkit-inner-spin-button{height:auto}[type=search]{outline-offset:-2px;-webkit-appearance:textfield}::-webkit-search-decoration{-webkit-appearance:none}::-webkit-color-swatch-wrapper{padding:0}::file-selector-button{font:inherit}::-webkit-file-upload-button{font:inherit;-webkit-appearance:button}output{display:inline-block}iframe{border:0}summary{display:list-item;cursor:pointer}progress{vertical-align:baseline}[hidden]{display:none!important}</style>
<style type="text/css">/*! pygments syntax highlighting */pre{line-height:125%;}td.linenos pre{color:#000000; background-color:#f0f0f0; padding-left:5px; padding-right:5px;}span.linenos{color:#000000; background-color:#f0f0f0; padding-left:5px; padding-right:5px;}td.linenos pre.special{color:#000000; background-color:#ffffc0; padding-left:5px; padding-right:5px;}span.linenos.special{color:#000000; background-color:#ffffc0; padding-left:5px; padding-right:5px;}.pdoc .hll{background-color:#ffffcc}.pdoc{background:#f8f8f8;}.pdoc .c{color:#408080; font-style:italic}.pdoc .err{border:1px solid #FF0000}.pdoc .k{color:#008000; font-weight:bold}.pdoc .o{color:#666666}.pdoc .ch{color:#408080; font-style:italic}.pdoc .cm{color:#408080; font-style:italic}.pdoc .cp{color:#BC7A00}.pdoc .cpf{color:#408080; font-style:italic}.pdoc .c1{color:#408080; font-style:italic}.pdoc .cs{color:#408080; font-style:italic}.pdoc .gd{color:#A00000}.pdoc .ge{font-style:italic}.pdoc .gr{color:#FF0000}.pdoc .gh{color:#000080; font-weight:bold}.pdoc .gi{color:#00A000}.pdoc .go{color:#888888}.pdoc .gp{color:#000080; font-weight:bold}.pdoc .gs{font-weight:bold}.pdoc .gu{color:#800080; font-weight:bold}.pdoc .gt{color:#0044DD}.pdoc .kc{color:#008000; font-weight:bold}.pdoc .kd{color:#008000; font-weight:bold}.pdoc .kn{color:#008000; font-weight:bold}.pdoc .kp{color:#008000}.pdoc .kr{color:#008000; font-weight:bold}.pdoc .kt{color:#B00040}.pdoc .m{color:#666666}.pdoc .s{color:#BA2121}.pdoc .na{color:#7D9029}.pdoc .nb{color:#008000}.pdoc .nc{color:#0000FF; font-weight:bold}.pdoc .no{color:#880000}.pdoc .nd{color:#AA22FF}.pdoc .ni{color:#999999; font-weight:bold}.pdoc .ne{color:#D2413A; font-weight:bold}.pdoc .nf{color:#0000FF}.pdoc .nl{color:#A0A000}.pdoc .nn{color:#0000FF; font-weight:bold}.pdoc .nt{color:#008000; font-weight:bold}.pdoc .nv{color:#19177C}.pdoc .ow{color:#AA22FF; font-weight:bold}.pdoc .w{color:#bbbbbb}.pdoc .mb{color:#666666}.pdoc .mf{color:#666666}.pdoc .mh{color:#666666}.pdoc .mi{color:#666666}.pdoc .mo{color:#666666}.pdoc .sa{color:#BA2121}.pdoc .sb{color:#BA2121}.pdoc .sc{color:#BA2121}.pdoc .dl{color:#BA2121}.pdoc .sd{color:#BA2121; font-style:italic}.pdoc .s2{color:#BA2121}.pdoc .se{color:#BB6622; font-weight:bold}.pdoc .sh{color:#BA2121}.pdoc .si{color:#BB6688; font-weight:bold}.pdoc .sx{color:#008000}.pdoc .sr{color:#BB6688}.pdoc .s1{color:#BA2121}.pdoc .ss{color:#19177C}.pdoc .bp{color:#008000}.pdoc .fm{color:#0000FF}.pdoc .vc{color:#19177C}.pdoc .vg{color:#19177C}.pdoc .vi{color:#19177C}.pdoc .vm{color:#19177C}.pdoc .il{color:#666666}</style>
<style type="text/css">/*! pdoc */:root{--pdoc-background:#fff;}.pdoc{--text:#212529;--muted:#6c757d;--link:#3660a5;--link-hover:#1659c5;--code:#f7f7f7;--active:#fff598;--accent:#eee;--accent2:#c1c1c1;--nav-hover:rgba(255, 255, 255, 0.5);--name:#0066BB;--def:#008800;--annotation:#007020;}body{background-color:var(--pdoc-background);}html, body{width:100%;height:100%;}@media (max-width:769px){#navtoggle{cursor:pointer;position:absolute;width:50px;height:40px;top:1rem;right:1rem;border-color:var(--text);color:var(--text);display:flex;opacity:0.8;}#navtoggle:hover{opacity:1;}#togglestate + div{display:none;}#togglestate:checked + div{display:inherit;}main{padding:2rem 3vw;}.git-button{display:none !important;}}@media (min-width:770px){:root{--sidebar-width:clamp(12.5rem, 28vw, 22rem);}nav{position:fixed;overflow:auto;height:100vh;width:var(--sidebar-width);}main{padding:3rem 2rem 3rem calc(var(--sidebar-width) + 3rem);width:calc(54rem + var(--sidebar-width));max-width:100%;}#navtoggle{display:none;}}#togglestate{display:none;}nav.pdoc{--pad:1.75rem;--indent:1.5rem;background-color:var(--accent);border-right:1px solid var(--accent2);box-shadow:0 0 20px rgba(50, 50, 50, .2) inset;padding:0 0 0 var(--pad);overflow-wrap:anywhere;scrollbar-width:thin; scrollbar-color:var(--accent2) transparent }nav.pdoc::-webkit-scrollbar{width:.4rem; }nav.pdoc::-webkit-scrollbar-thumb{background-color:var(--accent2); }nav.pdoc > div{padding:var(--pad) 0;}nav.pdoc .module-list-button{display:inline-flex;align-items:center;color:var(--text);border-color:var(--muted);margin-bottom:1rem;}nav.pdoc .module-list-button:hover{border-color:var(--text);}nav.pdoc ul{list-style:none;padding-left:0;}nav.pdoc li{display:block;margin:0;padding:.2rem 0 .2rem var(--indent);transition:all 100ms;}nav.pdoc > div > ul > li{padding-left:0;}nav.pdoc li:hover{background-color:var(--nav-hover);}nav.pdoc a, nav.pdoc a:hover{color:var(--text);}nav.pdoc a{display:block;}nav.pdoc > h2:first-of-type{margin-top:1.5rem;}nav.pdoc .class:before{content:"class ";color:var(--muted);}nav.pdoc .function:after{content:"()";color:var(--muted);}html, main{scroll-behavior:smooth;}.pdoc{color:var(--text);box-sizing:border-box;line-height:1.5;background:none;}.pdoc .pdoc-button{display:inline-block;border:solid black 1px;border-radius:2px;font-size:.75rem;padding:calc(0.5em - 1px) 1em;transition:100ms all;}.pdoc .visually-hidden{position:absolute !important;width:1px !important;height:1px !important;padding:0 !important;margin:-1px !important;overflow:hidden !important;clip:rect(0, 0, 0, 0) !important;white-space:nowrap !important;border:0 !important;}.pdoc h1, .pdoc h2, .pdoc h3, .pdoc h4{font-weight:300;margin:.3em 0;padding:.2em 0;}.pdoc a{text-decoration:none;color:var(--link);}.pdoc a:hover{color:var(--link-hover);}.pdoc blockquote{margin-left:2rem;}.pdoc pre{background-color:var(--code);border-top:1px solid var(--accent2);border-bottom:1px solid var(--accent2);margin-bottom:1em;padding:.5rem 0 .5rem .5rem;overflow-x:auto;}.pdoc code{color:var(--text);padding:.2em .4em;margin:0;font-size:85%;background-color:var(--code);border-radius:6px;}.pdoc a > code{color:inherit;}.pdoc pre > code{display:inline-block;font-size:inherit;background:none;border:none;padding:0;}.pdoc .modulename{margin-top:0;font-weight:bold;}.pdoc .modulename a{color:var(--link);transition:100ms all;}.pdoc .git-button{float:right;border:solid var(--link) 1px;}.pdoc .git-button:hover{background-color:var(--link);color:var(--pdoc-background);}.pdoc details{--shift:-40px;text-align:right;margin-top:var(--shift);margin-bottom:calc(0px - var(--shift));clear:both;filter:opacity(1);}.pdoc details:not([open]){height:0;overflow:visible;}.pdoc details > summary{font-size:.75rem;cursor:pointer;color:var(--muted);border-width:0;padding:0 .7em;display:inline-block;display:inline list-item;user-select:none;}.pdoc details > summary:focus{outline:0;}.pdoc details > div{margin-top:calc(0px - var(--shift) / 2);text-align:left;}.pdoc .docstring{margin-bottom:1.5rem;}.pdoc > section:first-of-type > .docstring{margin-bottom:3rem;}.pdoc .docstring pre{margin-left:1em;margin-right:1em;}.pdoc h1:target,.pdoc h2:target,.pdoc h3:target,.pdoc h4:target,.pdoc h5:target,.pdoc h6:target{background-color:var(--active);box-shadow:-1rem 0 0 0 var(--active);}.pdoc div:target > .attr,.pdoc section:target > .attr,.pdoc dd:target > a{background-color:var(--active);}.pdoc .attr:hover{filter:contrast(0.95);}.pdoc .headerlink{position:absolute;width:0;margin-left:-1.5rem;line-height:1.4rem;font-size:1.5rem;font-weight:normal;transition:all 100ms ease-in-out;opacity:0;}.pdoc .attr > .headerlink{margin-left:-2.5rem;}.pdoc *:hover > .headerlink,.pdoc *:target > .attr > .headerlink{opacity:1;}.pdoc .attr{color:var(--text);margin:1rem 0 .5rem;padding:.4rem 5rem .4rem 1rem;background-color:var(--accent);}.pdoc .classattr{margin-left:2rem;}.pdoc .name{color:var(--name);font-weight:bold;}.pdoc .def{color:var(--def);font-weight:bold;}.pdoc .signature{white-space:pre-wrap;}.pdoc .annotation{color:var(--annotation);}.pdoc .inherited{margin-left:2rem;}.pdoc .inherited dt{font-weight:700;}.pdoc .inherited dt, .pdoc .inherited dd{display:inline;margin-left:0;margin-bottom:.5rem;}.pdoc .inherited dd:not(:last-child):after{content:", ";}.pdoc .inherited .class:before{content:"class ";}.pdoc .inherited .function a:after{content:"()";}.pdoc .attribution{margin-top:2rem;display:block;opacity:0.5;transition:all 200ms;filter:grayscale(100%);}.pdoc .attribution:hover{opacity:1;filter:grayscale(0%);}.pdoc .attribution img{margin-left:5px;height:35px;vertical-align:middle;width:70px;transition:all 200ms;}</style>
</head>
<body>        <nav class="pdoc">
            <label id="navtoggle" for="togglestate" class="pdoc-button"><svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 30 30'><path stroke-linecap='round' stroke="currentColor" stroke-miterlimit='10' stroke-width='2' d='M4 7h22M4 15h22M4 23h22'/></svg></label>
            <input id="togglestate" type="checkbox">
            <div>
                        <a class="pdoc-button module-list-button" href="../siti_tools.html">
<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-box-arrow-in-left" viewBox="0 0 16 16">
  <path fill-rule="evenodd" d="M10 3.5a.5.5 0 0 0-.5-.5h-8a.5.5 0 0 0-.5.5v9a.5.5 0 0 0 .5.5h8a.5.5 0 0 0 .5-.5v-2a.5.5 0 0 1 1 0v2A1.5 1.5 0 0 1 9.5 14h-8A1.5 1.5 0 0 1 0 12.5v-9A1.5 1.5 0 0 1 1.5 2h8A1.5 1.5 0 0 1 11 3.5v2a.5.5 0 0 1-1 0v-2z"/>
  <path fill-rule="evenodd" d="M4.146 8.354a.5.5 0 0 1 0-.708l3-3a.5.5 0 1 1 .708.708L5.707 7.5H14.5a.5.5 0 0 1 0 1H5.707l2.147 2.146a.5.5 0 0 1-.708.708l-3-3z"/>
</svg>                            &nbsp;siti_tools</a>




                    <h2>API Documentation</h2>
                        <ul class="memberlist">
            <li>
                    <a class="class" href="#EnumArg">EnumArg</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#EnumArg.__init__">EnumArg</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#HdrMode">HdrMode</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#HdrMode.__init__">HdrMode</a>
                        </li>
                        <li>
                                <a class="variable" href="#HdrMode.SDR">SDR</a>
                        </li>
                        <li>
                                <a class="variable" href="#HdrMode.HDR10">HDR10</a>
                        </li>
                        <li>
                                <a class="variable" href="#HdrMode.HLG">HLG</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#ColorRange">ColorRange</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#ColorRange.__init__">ColorRange</a>
                        </li>
                        <li>
                                <a class="variable" href="#ColorRange.LIMITED">LIMITED</a>
                        </li>
                        <li>
                                <a class="variable" href="#ColorRange.FULL">FULL</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#EotfFunction">EotfFunction</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#EotfFunction.__init__">EotfFunction</a>
                        </li>
                        <li>
                                <a class="variable" href="#EotfFunction.BT1886">BT1886</a>
                        </li>
                        <li>
                                <a class="variable" href="#EotfFunction.INV_SRGB">INV_SRGB</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#CalculationDomain">CalculationDomain</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#CalculationDomain.__init__">CalculationDomain</a>
                        </li>
                        <li>
                                <a class="variable" href="#CalculationDomain.PQ">PQ</a>
                        </li>
                        <li>
                                <a class="variable" href="#CalculationDomain.PU21">PU21</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#Pu21Mode">Pu21Mode</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#Pu21Mode.__init__">Pu21Mode</a>
                        </li>
                        <li>
                                <a class="variable" href="#Pu21Mode.BANDING">BANDING</a>
                        </li>
                        <li>
                                <a class="variable" href="#Pu21Mode.BANDING_GLARE">BANDING_GLARE</a>
                        </li>
                        <li>
                                <a class="variable" href="#Pu21Mode.PEAKS">PEAKS</a>
                        </li>
                        <li>
                                <a class="variable" href="#Pu21Mode.PEAKS_GLARE">PEAKS_GLARE</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#SiTiCalculator">SiTiCalculator</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#SiTiCalculator.__init__">SiTiCalculator</a>
                        </li>
                        <li>
                                <a class="variable" href="#SiTiCalculator.DEFAULT_HDR_MODE">DEFAULT_HDR_MODE</a>
                        </li>
                        <li>
                                <a class="variable" href="#SiTiCalculator.DEFAULT_BIT_DEPTH">DEFAULT_BIT_DEPTH</a>
                        </li>
                        <li>
                                <a class="variable" href="#SiTiCalculator.DEFAULT_COLOR_RANGE">DEFAULT_COLOR_RANGE</a>
                        </li>
                        <li>
                                <a class="variable" href="#SiTiCalculator.DEFAULT_EOTF_FUNCTION">DEFAULT_EOTF_FUNCTION</a>
                        </li>
                        <li>
                                <a class="variable" href="#SiTiCalculator.DEFAULT_CALCULATION_DOMAIN">DEFAULT_CALCULATION_DOMAIN</a>
                        </li>
                        <li>
                                <a class="variable" href="#SiTiCalculator.DEFAULT_PU21_MODE">DEFAULT_PU21_MODE</a>
                        </li>
                        <li>
                                <a class="variable" href="#SiTiCalculator.DEFAULT_GAMMA">DEFAULT_GAMMA</a>
                        </li>
                        <li>
                                <a class="variable" href="#SiTiCalculator.DEFAULT_L_MIN">DEFAULT_L_MIN</a>
                        </li>
                        <li>
                                <a class="variable" href="#SiTiCalculator.DEFAULT_L_MAX">DEFAULT_L_MAX</a>
                        </li>
                        <li>
                                <a class="variable" href="#SiTiCalculator.DEFAULT_L_MIN_HDR">DEFAULT_L_MIN_HDR</a>
                        </li>
                        <li>
                                <a class="variable" href="#SiTiCalculator.DEFAULT_L_MAX_HDR">DEFAULT_L_MAX_HDR</a>
                        </li>
                        <li>
                                <a class="variable" href="#SiTiCalculator.LIMITED_RANGE_MIN">LIMITED_RANGE_MIN</a>
                        </li>
                        <li>
                                <a class="variable" href="#SiTiCalculator.LIMITED_RANGE_MAX">LIMITED_RANGE_MAX</a>
                        </li>
                        <li>
                                <a class="function" href="#SiTiCalculator.from_settings">from_settings</a>
                        </li>
                        <li>
                                <a class="variable" href="#SiTiCalculator.callbacks">callbacks</a>
                        </li>
                        <li>
                                <a class="variable" href="#SiTiCalculator.si_values">si_values</a>
                        </li>
                        <li>
                                <a class="variable" href="#SiTiCalculator.ti_values">ti_values</a>
                        </li>
                        <li>
                                <a class="variable" href="#SiTiCalculator.last_input_file">last_input_file</a>
                        </li>
                        <li>
                                <a class="function" href="#SiTiCalculator.get_general_settings">get_general_settings</a>
                        </li>
                        <li>
                                <a class="function" href="#SiTiCalculator.si">si</a>
                        </li>
                        <li>
                                <a class="function" href="#SiTiCalculator.ti">ti</a>
                        </li>
                        <li>
                                <a class="function" href="#SiTiCalculator.eotf_1886">eotf_1886</a>
                        </li>
                        <li>
                                <a class="function" href="#SiTiCalculator.eotf_inv_srgb">eotf_inv_srgb</a>
                        </li>
                        <li>
                                <a class="function" href="#SiTiCalculator.apply_display_model">apply_display_model</a>
                        </li>
                        <li>
                                <a class="function" href="#SiTiCalculator.oetf_pq">oetf_pq</a>
                        </li>
                        <li>
                                <a class="function" href="#SiTiCalculator.oetf_pu21">oetf_pu21</a>
                        </li>
                        <li>
                                <a class="function" href="#SiTiCalculator.eotf_hlg">eotf_hlg</a>
                        </li>
                        <li>
                                <a class="function" href="#SiTiCalculator.normalize_to_original_range">normalize_to_original_range</a>
                        </li>
                        <li>
                                <a class="function" href="#SiTiCalculator.normalize_to_original_si_range">normalize_to_original_si_range</a>
                        </li>
                        <li>
                                <a class="function" href="#SiTiCalculator.normalize_between_0_1">normalize_between_0_1</a>
                        </li>
                        <li>
                                <a class="function" href="#SiTiCalculator.add_frame_callback">add_frame_callback</a>
                        </li>
                        <li>
                                <a class="function" href="#SiTiCalculator.handle_limited_range">handle_limited_range</a>
                        </li>
                        <li>
                                <a class="function" href="#SiTiCalculator.plot_histogram">plot_histogram</a>
                        </li>
                        <li>
                                <a class="function" href="#SiTiCalculator.calculate">calculate</a>
                        </li>
                        <li>
                                <a class="function" href="#SiTiCalculator.get_csv_results">get_csv_results</a>
                        </li>
                        <li>
                                <a class="function" href="#SiTiCalculator.get_results">get_results</a>
                        </li>
                </ul>

            </li>
    </ul>


                    <a class="attribution" title="pdoc: Python API documentation generator" href="https://pdoc.dev">
                        built with <span class="visually-hidden">pdoc</span><img
                            alt="pdoc logo"
                            src="data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20role%3D%22img%22%20aria-label%3D%22pdoc%20logo%22%20width%3D%22300%22%20height%3D%22150%22%20viewBox%3D%22-1%200%2060%2030%22%3E%3Ctitle%3Epdoc%3C/title%3E%3Cpath%20d%3D%22M29.621%2021.293c-.011-.273-.214-.475-.511-.481a.5.5%200%200%200-.489.503l-.044%201.393c-.097.551-.695%201.215-1.566%201.704-.577.428-1.306.486-2.193.182-1.426-.617-2.467-1.654-3.304-2.487l-.173-.172a3.43%203.43%200%200%200-.365-.306.49.49%200%200%200-.286-.196c-1.718-1.06-4.931-1.47-7.353.191l-.219.15c-1.707%201.187-3.413%202.131-4.328%201.03-.02-.027-.49-.685-.141-1.763.233-.721.546-2.408.772-4.076.042-.09.067-.187.046-.288.166-1.347.277-2.625.241-3.351%201.378-1.008%202.271-2.586%202.271-4.362%200-.976-.272-1.935-.788-2.774-.057-.094-.122-.18-.184-.268.033-.167.052-.339.052-.516%200-1.477-1.202-2.679-2.679-2.679-.791%200-1.496.352-1.987.9a6.3%206.3%200%200%200-1.001.029c-.492-.564-1.207-.929-2.012-.929-1.477%200-2.679%201.202-2.679%202.679A2.65%202.65%200%200%200%20.97%206.554c-.383.747-.595%201.572-.595%202.41%200%202.311%201.507%204.29%203.635%205.107-.037.699-.147%202.27-.423%203.294l-.137.461c-.622%202.042-2.515%208.257%201.727%2010.643%201.614.908%203.06%201.248%204.317%201.248%202.665%200%204.492-1.524%205.322-2.401%201.476-1.559%202.886-1.854%206.491.82%201.877%201.393%203.514%201.753%204.861%201.068%202.223-1.713%202.811-3.867%203.399-6.374.077-.846.056-1.469.054-1.537zm-4.835%204.313c-.054.305-.156.586-.242.629-.034-.007-.131-.022-.307-.157-.145-.111-.314-.478-.456-.908.221.121.432.25.675.355.115.039.219.051.33.081zm-2.251-1.238c-.05.33-.158.648-.252.694-.022.001-.125-.018-.307-.157-.217-.166-.488-.906-.639-1.573.358.344.754.693%201.198%201.036zm-3.887-2.337c-.006-.116-.018-.231-.041-.342.635.145%201.189.368%201.599.625.097.231.166.481.174.642-.03.049-.055.101-.067.158-.046.013-.128.026-.298.004-.278-.037-.901-.57-1.367-1.087zm-1.127-.497c.116.306.176.625.12.71-.019.014-.117.045-.345.016-.206-.027-.604-.332-.986-.695.41-.051.816-.056%201.211-.031zm-4.535%201.535c.209.22.379.47.358.598-.006.041-.088.138-.351.234-.144.055-.539-.063-.979-.259a11.66%2011.66%200%200%200%20.972-.573zm.983-.664c.359-.237.738-.418%201.126-.554.25.237.479.548.457.694-.006.042-.087.138-.351.235-.174.064-.694-.105-1.232-.375zm-3.381%201.794c-.022.145-.061.29-.149.401-.133.166-.358.248-.69.251h-.002c-.133%200-.306-.26-.45-.621.417.091.854.07%201.291-.031zm-2.066-8.077a4.78%204.78%200%200%201-.775-.584c.172-.115.505-.254.88-.378l-.105.962zm-.331%202.302a10.32%2010.32%200%200%201-.828-.502c.202-.143.576-.328.984-.49l-.156.992zm-.45%202.157l-.701-.403c.214-.115.536-.249.891-.376a11.57%2011.57%200%200%201-.19.779zm-.181%201.716c.064.398.194.702.298.893-.194-.051-.435-.162-.736-.398.061-.119.224-.3.438-.495zM8.87%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zm-.735-.389a1.15%201.15%200%200%200-.314.783%201.16%201.16%200%200%200%201.162%201.162c.457%200%20.842-.27%201.032-.653.026.117.042.238.042.362a1.68%201.68%200%200%201-1.679%201.679%201.68%201.68%200%200%201-1.679-1.679c0-.843.626-1.535%201.436-1.654zM5.059%205.406A1.68%201.68%200%200%201%203.38%207.085a1.68%201.68%200%200%201-1.679-1.679c0-.037.009-.072.011-.109.21.3.541.508.935.508a1.16%201.16%200%200%200%201.162-1.162%201.14%201.14%200%200%200-.474-.912c.015%200%20.03-.005.045-.005.926.001%201.679.754%201.679%201.68zM3.198%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zM1.375%208.964c0-.52.103-1.035.288-1.52.466.394%201.06.64%201.717.64%201.144%200%202.116-.725%202.499-1.738.383%201.012%201.355%201.738%202.499%201.738.867%200%201.631-.421%202.121-1.062.307.605.478%201.267.478%201.942%200%202.486-2.153%204.51-4.801%204.51s-4.801-2.023-4.801-4.51zm24.342%2019.349c-.985.498-2.267.168-3.813-.979-3.073-2.281-5.453-3.199-7.813-.705-1.315%201.391-4.163%203.365-8.423.97-3.174-1.786-2.239-6.266-1.261-9.479l.146-.492c.276-1.02.395-2.457.444-3.268a6.11%206.11%200%200%200%201.18.115%206.01%206.01%200%200%200%202.536-.562l-.006.175c-.802.215-1.848.612-2.021%201.25-.079.295.021.601.274.837.219.203.415.364.598.501-.667.304-1.243.698-1.311%201.179-.02.144-.022.507.393.787.213.144.395.26.564.365-1.285.521-1.361.96-1.381%201.126-.018.142-.011.496.427.746l.854.489c-.473.389-.971.914-.999%201.429-.018.278.095.532.316.713.675.556%201.231.721%201.653.721.059%200%20.104-.014.158-.02.207.707.641%201.64%201.513%201.64h.013c.8-.008%201.236-.345%201.462-.626.173-.216.268-.457.325-.692.424.195.93.374%201.372.374.151%200%20.294-.021.423-.068.732-.27.944-.704.993-1.021.009-.061.003-.119.002-.179.266.086.538.147.789.147.15%200%20.294-.021.423-.069.542-.2.797-.489.914-.754.237.147.478.258.704.288.106.014.205.021.296.021.356%200%20.595-.101.767-.229.438.435%201.094.992%201.656%201.067.106.014.205.021.296.021a1.56%201.56%200%200%200%20.323-.035c.17.575.453%201.289.866%201.605.358.273.665.362.914.362a.99.99%200%200%200%20.421-.093%201.03%201.03%200%200%200%20.245-.164c.168.428.39.846.68%201.068.358.273.665.362.913.362a.99.99%200%200%200%20.421-.093c.317-.148.512-.448.639-.762.251.157.495.257.726.257.127%200%20.25-.024.37-.071.427-.17.706-.617.841-1.314.022-.015.047-.022.068-.038.067-.051.133-.104.196-.159-.443%201.486-1.107%202.761-2.086%203.257zM8.66%209.925a.5.5%200%201%200-1%200c0%20.653-.818%201.205-1.787%201.205s-1.787-.552-1.787-1.205a.5.5%200%201%200-1%200c0%201.216%201.25%202.205%202.787%202.205s2.787-.989%202.787-2.205zm4.4%2015.965l-.208.097c-2.661%201.258-4.708%201.436-6.086.527-1.542-1.017-1.88-3.19-1.844-4.198a.4.4%200%200%200-.385-.414c-.242-.029-.406.164-.414.385-.046%201.249.367%203.686%202.202%204.896.708.467%201.547.7%202.51.7%201.248%200%202.706-.392%204.362-1.174l.185-.086a.4.4%200%200%200%20.205-.527c-.089-.204-.326-.291-.527-.206zM9.547%202.292c.093.077.205.114.317.114a.5.5%200%200%200%20.318-.886L8.817.397a.5.5%200%200%200-.703.068.5.5%200%200%200%20.069.703l1.364%201.124zm-7.661-.065c.086%200%20.173-.022.253-.068l1.523-.893a.5.5%200%200%200-.506-.863l-1.523.892a.5.5%200%200%200-.179.685c.094.158.261.247.432.247z%22%20transform%3D%22matrix%28-1%200%200%201%2058%200%29%22%20fill%3D%22%233bb300%22/%3E%3Cpath%20d%3D%22M.3%2021.86V10.18q0-.46.02-.68.04-.22.18-.5.28-.54%201.34-.54%201.06%200%201.42.28.38.26.44.78.76-1.04%202.38-1.04%201.64%200%203.1%201.54%201.46%201.54%201.46%203.58%200%202.04-1.46%203.58-1.44%201.54-3.08%201.54-1.64%200-2.38-.92v4.04q0%20.46-.04.68-.02.22-.18.5-.14.3-.5.42-.36.12-.98.12-.62%200-1-.12-.36-.12-.52-.4-.14-.28-.18-.5-.02-.22-.02-.68zm3.96-9.42q-.46.54-.46%201.18%200%20.64.46%201.18.48.52%201.2.52.74%200%201.24-.52.52-.52.52-1.18%200-.66-.48-1.18-.48-.54-1.26-.54-.76%200-1.22.54zm14.741-8.36q.16-.3.54-.42.38-.12%201-.12.64%200%201.02.12.38.12.52.42.16.3.18.54.04.22.04.68v11.94q0%20.46-.04.7-.02.22-.18.5-.3.54-1.7.54-1.38%200-1.54-.98-.84.96-2.34.96-1.8%200-3.28-1.56-1.48-1.58-1.48-3.66%200-2.1%201.48-3.68%201.5-1.58%203.28-1.58%201.48%200%202.3%201v-4.2q0-.46.02-.68.04-.24.18-.52zm-3.24%2010.86q.52.54%201.26.54.74%200%201.22-.54.5-.54.5-1.18%200-.66-.48-1.22-.46-.56-1.26-.56-.8%200-1.28.56-.48.54-.48%201.2%200%20.66.52%201.2zm7.833-1.2q0-2.4%201.68-3.96%201.68-1.56%203.84-1.56%202.16%200%203.82%201.56%201.66%201.54%201.66%203.94%200%201.66-.86%202.96-.86%201.28-2.1%201.9-1.22.6-2.54.6-1.32%200-2.56-.64-1.24-.66-2.1-1.92-.84-1.28-.84-2.88zm4.18%201.44q.64.48%201.3.48.66%200%201.32-.5.66-.5.66-1.48%200-.98-.62-1.46-.62-.48-1.34-.48-.72%200-1.34.5-.62.5-.62%201.48%200%20.96.64%201.46zm11.412-1.44q0%20.84.56%201.32.56.46%201.18.46.64%200%201.18-.36.56-.38.9-.38.6%200%201.46%201.06.46.58.46%201.04%200%20.76-1.1%201.42-1.14.8-2.8.8-1.86%200-3.58-1.34-.82-.64-1.34-1.7-.52-1.08-.52-2.36%200-1.3.52-2.34.52-1.06%201.34-1.7%201.66-1.32%203.54-1.32.76%200%201.48.22.72.2%201.06.4l.32.2q.36.24.56.38.52.4.52.92%200%20.5-.42%201.14-.72%201.1-1.38%201.1-.38%200-1.08-.44-.36-.34-1.04-.34-.66%200-1.24.48-.58.48-.58%201.34z%22%20fill%3D%22green%22/%3E%3C/svg%3E"/>
                    </a>
            </div>
        </nav>
    <main class="pdoc">
            <section>
                    <h1 class="modulename">
<a href="./../siti_tools.html">siti_tools</a>.siti    </h1>

                
                        <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span><span class="c1"># This file is part of siti_tools</span>
<span class="c1">#</span>
<span class="c1"># MIT License</span>
<span class="c1">#</span>
<span class="c1"># siti_tools, Copyright (c) 2021 Werner Robitza</span>
<span class="c1">#</span>
<span class="c1"># Permission is hereby granted, free of charge, to any person obtaining a copy</span>
<span class="c1"># of this software and associated documentation files (the &quot;Software&quot;), to deal</span>
<span class="c1"># in the Software without restriction, including without limitation the rights</span>
<span class="c1"># to use, copy, modify, merge, publish, distribute, sublicense, and/or sell</span>
<span class="c1"># copies of the Software, and to permit persons to whom the Software is</span>
<span class="c1"># furnished to do so, subject to the following conditions:</span>
<span class="c1">#</span>
<span class="c1"># The above copyright notice and this permission notice shall be included in all</span>
<span class="c1"># copies or substantial portions of the Software.</span>
<span class="c1">#</span>
<span class="c1"># THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR</span>
<span class="c1"># IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,</span>
<span class="c1"># FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE</span>
<span class="c1"># AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER</span>
<span class="c1"># LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,</span>
<span class="c1"># OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE</span>
<span class="c1"># SOFTWARE.</span>

<span class="kn">import</span> <span class="nn">csv</span>
<span class="kn">import</span> <span class="nn">io</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">plotille</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Union</span><span class="p">,</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">cast</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">ndimage</span>
<span class="kn">from</span> <span class="nn">enum</span> <span class="kn">import</span> <span class="n">Enum</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="kn">from</span> <span class="nn">.file</span> <span class="kn">import</span> <span class="n">read_container</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">__version__</span> <span class="k">as</span> <span class="n">version</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;siti&quot;</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">EnumArg</span><span class="p">(</span><span class="n">Enum</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span>


<span class="k">class</span> <span class="nc">HdrMode</span><span class="p">(</span><span class="n">EnumArg</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Mode of HDR calculation, should be SDR by default</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">SDR</span> <span class="o">=</span> <span class="s2">&quot;sdr&quot;</span>
    <span class="n">HDR10</span> <span class="o">=</span> <span class="s2">&quot;hdr10&quot;</span>
    <span class="n">HLG</span> <span class="o">=</span> <span class="s2">&quot;hlg&quot;</span>


<span class="k">class</span> <span class="nc">ColorRange</span><span class="p">(</span><span class="n">EnumArg</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Limited or full range, where limited is from 16-235, and full is from 0-255.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">LIMITED</span> <span class="o">=</span> <span class="s2">&quot;limited&quot;</span>
    <span class="n">FULL</span> <span class="o">=</span> <span class="s2">&quot;full&quot;</span>


<span class="k">class</span> <span class="nc">EotfFunction</span><span class="p">(</span><span class="n">EnumArg</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    EOTF for converting SDR</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">BT1886</span> <span class="o">=</span> <span class="s2">&quot;bt1886&quot;</span>
    <span class="n">INV_SRGB</span> <span class="o">=</span> <span class="s2">&quot;inv_srgb&quot;</span>


<span class="k">class</span> <span class="nc">CalculationDomain</span><span class="p">(</span><span class="n">EnumArg</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Domain in which to calculate SI/TI</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">PQ</span> <span class="o">=</span> <span class="s2">&quot;pq&quot;</span>
    <span class="n">PU21</span> <span class="o">=</span> <span class="s2">&quot;pu21&quot;</span>


<span class="k">class</span> <span class="nc">Pu21Mode</span><span class="p">(</span><span class="n">EnumArg</span><span class="p">):</span>
    <span class="n">BANDING</span> <span class="o">=</span> <span class="s2">&quot;banding&quot;</span>
    <span class="n">BANDING_GLARE</span> <span class="o">=</span> <span class="s2">&quot;banding_glare&quot;</span>
    <span class="n">PEAKS</span> <span class="o">=</span> <span class="s2">&quot;peaks&quot;</span>
    <span class="n">PEAKS_GLARE</span> <span class="o">=</span> <span class="s2">&quot;peaks_glare&quot;</span>


<span class="k">class</span> <span class="nc">SiTiCalculator</span><span class="p">:</span>
    <span class="n">DEFAULT_HDR_MODE</span> <span class="o">=</span> <span class="n">HdrMode</span><span class="o">.</span><span class="n">SDR</span>
    <span class="n">DEFAULT_BIT_DEPTH</span> <span class="o">=</span> <span class="mi">8</span>  <span class="c1"># or 10, 12</span>
    <span class="n">DEFAULT_COLOR_RANGE</span> <span class="o">=</span> <span class="n">ColorRange</span><span class="o">.</span><span class="n">LIMITED</span>
    <span class="n">DEFAULT_EOTF_FUNCTION</span> <span class="o">=</span> <span class="n">EotfFunction</span><span class="o">.</span><span class="n">BT1886</span>
    <span class="n">DEFAULT_CALCULATION_DOMAIN</span> <span class="o">=</span> <span class="n">CalculationDomain</span><span class="o">.</span><span class="n">PQ</span>
    <span class="n">DEFAULT_PU21_MODE</span> <span class="o">=</span> <span class="n">Pu21Mode</span><span class="o">.</span><span class="n">BANDING</span>
    <span class="n">DEFAULT_GAMMA</span> <span class="o">=</span> <span class="mf">2.4</span>  <span class="c1"># for BT.1886</span>
    <span class="n">DEFAULT_L_MIN</span> <span class="o">=</span> <span class="mf">0.1</span>
    <span class="n">DEFAULT_L_MAX</span> <span class="o">=</span> <span class="mi">300</span>
    <span class="n">DEFAULT_L_MIN_HDR</span> <span class="o">=</span> <span class="mf">0.01</span>
    <span class="n">DEFAULT_L_MAX_HDR</span> <span class="o">=</span> <span class="mf">1000.0</span>

    <span class="n">LIMITED_RANGE_MIN</span> <span class="o">=</span> <span class="mi">16</span> <span class="o">/</span> <span class="mi">255</span>
    <span class="n">LIMITED_RANGE_MAX</span> <span class="o">=</span> <span class="mi">235</span> <span class="o">/</span> <span class="mi">255</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">from_settings</span><span class="p">(</span><span class="n">settings</span><span class="p">:</span> <span class="n">Dict</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">SiTiCalculator</span><span class="p">(</span><span class="o">**</span><span class="n">settings</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">hdr_mode</span><span class="p">:</span> <span class="n">HdrMode</span> <span class="o">=</span> <span class="n">DEFAULT_HDR_MODE</span><span class="p">,</span>
        <span class="n">bit_depth</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">DEFAULT_BIT_DEPTH</span><span class="p">,</span>
        <span class="n">color_range</span><span class="p">:</span> <span class="n">ColorRange</span> <span class="o">=</span> <span class="n">DEFAULT_COLOR_RANGE</span><span class="p">,</span>
        <span class="n">eotf_function</span><span class="p">:</span> <span class="n">EotfFunction</span> <span class="o">=</span> <span class="n">DEFAULT_EOTF_FUNCTION</span><span class="p">,</span>
        <span class="n">calculation_domain</span><span class="p">:</span> <span class="n">CalculationDomain</span> <span class="o">=</span> <span class="n">DEFAULT_CALCULATION_DOMAIN</span><span class="p">,</span>
        <span class="n">l_max</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">l_min</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">gamma</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">DEFAULT_GAMMA</span><span class="p">,</span>
        <span class="n">pu21_mode</span><span class="p">:</span> <span class="n">Pu21Mode</span> <span class="o">=</span> <span class="n">DEFAULT_PU21_MODE</span><span class="p">,</span>
        <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">show_histogram</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">legacy</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a new SI/TI calculator</span>

<span class="sd">        Args:</span>
<span class="sd">            hdr_mode (HdrMode, optional): Select SDR, HDR10 or HLG. Defaults to SDR.</span>
<span class="sd">            bit_depth (int, optional): 8, 10 or 12. Defaults to 8.</span>
<span class="sd">            color_range (ColorRange, optional): Set the color range (limited or full). Defaults to limited.</span>
<span class="sd">            eotf_function (EotfFunction, optional): EOTF function for converting SDR to HDR. Defaults to BT.1886.</span>
<span class="sd">            calculation_domain (CalculationDomain, optional): Domain to calculate SI/TI in. Defaults to PQ.</span>
<span class="sd">            l_max (float, optional): Set the peak display luminance in cd/m2. Defaults to 300 (SDR) or 1000 (HDR).</span>
<span class="sd">            l_min (float, optional): Set the black display luminance in cd/m2. Defaults to 0.1 (SDR) or 0.01 (HDR).</span>
<span class="sd">            gamma (float, optional): Set the BT.1886 gamma. Defaults to 2.4.</span>
<span class="sd">            pu21_mode (Pu21Mode, optional): Set the default PU21 mode. Defaults to BANDING.</span>
<span class="sd">            verbose (bool, optional): Show verbose logging for the first frame.</span>
<span class="sd">            show_histogram (bool, optional): Show a histogram for the first frame (computation-intensive, implies verbose=True).</span>
<span class="sd">            legacy (bool, optional): Use legacy SI/TI calculation. Defaults to False.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">show_histogram</span> <span class="o">=</span> <span class="n">show_histogram</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">legacy</span> <span class="o">=</span> <span class="n">legacy</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_histogram</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">callbacks</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Callable</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">hdr_mode</span> <span class="o">=</span> <span class="n">hdr_mode</span>

        <span class="k">if</span> <span class="n">bit_depth</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">8</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">12</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Bit depth must be one of 8, 10, 12&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">bit_depth</span> <span class="o">=</span> <span class="n">bit_depth</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">color_range</span> <span class="o">=</span> <span class="n">color_range</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">eotf_function</span> <span class="o">=</span> <span class="n">eotf_function</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">calculation_domain</span> <span class="o">=</span> <span class="n">calculation_domain</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">pu21_mode</span> <span class="o">=</span> <span class="n">pu21_mode</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">oetf_function_kwargs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculation_domain</span> <span class="o">==</span> <span class="n">CalculationDomain</span><span class="o">.</span><span class="n">PQ</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">oetf_function</span> <span class="o">=</span> <span class="n">SiTiCalculator</span><span class="o">.</span><span class="n">oetf_pq</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">oetf_function</span> <span class="o">=</span> <span class="n">SiTiCalculator</span><span class="o">.</span><span class="n">oetf_pu21</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">oetf_function_kwargs</span><span class="p">[</span><span class="s2">&quot;mode&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pu21_mode</span>

        <span class="c1"># overwrite the default depending on HDR type</span>
        <span class="k">if</span> <span class="n">l_max</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">l_max</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">SiTiCalculator</span><span class="o">.</span><span class="n">DEFAULT_L_MAX</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hdr_mode</span> <span class="o">==</span> <span class="n">HdrMode</span><span class="o">.</span><span class="n">SDR</span>
                <span class="k">else</span> <span class="n">SiTiCalculator</span><span class="o">.</span><span class="n">DEFAULT_L_MAX_HDR</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">l_max</span> <span class="o">=</span> <span class="n">l_max</span>
        <span class="k">if</span> <span class="n">l_min</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">l_min</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">SiTiCalculator</span><span class="o">.</span><span class="n">DEFAULT_L_MIN</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hdr_mode</span> <span class="o">==</span> <span class="n">HdrMode</span><span class="o">.</span><span class="n">SDR</span>
                <span class="k">else</span> <span class="n">SiTiCalculator</span><span class="o">.</span><span class="n">DEFAULT_L_MIN_HDR</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">l_min</span> <span class="o">=</span> <span class="n">l_min</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">gamma</span> <span class="o">=</span> <span class="n">gamma</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">si_values</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ti_values</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="kc">None</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">last_input_file</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">get_general_settings</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        A dictionary of settings used for the calculation</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;calculation_domain&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">calculation_domain</span><span class="p">),</span>
            <span class="s2">&quot;hdr_mode&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hdr_mode</span><span class="p">),</span>
            <span class="s2">&quot;bit_depth&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">bit_depth</span><span class="p">,</span>
            <span class="s2">&quot;color_range&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">color_range</span><span class="p">),</span>
            <span class="s2">&quot;eotf_function&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">eotf_function</span><span class="p">),</span>
            <span class="s2">&quot;l_max&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">l_max</span><span class="p">,</span>
            <span class="s2">&quot;l_min&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">l_min</span><span class="p">,</span>
            <span class="s2">&quot;gamma&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">gamma</span><span class="p">,</span>
            <span class="s2">&quot;pu21_mode&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pu21_mode</span><span class="p">),</span>
            <span class="s2">&quot;legacy&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">legacy</span><span class="p">,</span>
            <span class="s2">&quot;version&quot;</span><span class="p">:</span> <span class="n">version</span><span class="p">,</span>
        <span class="p">}</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">si</span><span class="p">(</span><span class="n">frame_data</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Calculate SI of a frame</span>

<span class="sd">        Args:</span>
<span class="sd">            frame_data (ndarray): 2D array of input frame data</span>

<span class="sd">        Returns:</span>
<span class="sd">            float: SI</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># TODO: check array dimensions</span>

        <span class="c1"># calculate horizontal/vertical operators</span>
        <span class="n">sob_x</span> <span class="o">=</span> <span class="n">ndimage</span><span class="o">.</span><span class="n">sobel</span><span class="p">(</span><span class="n">frame_data</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">sob_y</span> <span class="o">=</span> <span class="n">ndimage</span><span class="o">.</span><span class="n">sobel</span><span class="p">(</span><span class="n">frame_data</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># crop output to valid window, calculate gradient magnitude</span>
        <span class="n">si</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hypot</span><span class="p">(</span><span class="n">sob_x</span><span class="p">,</span> <span class="n">sob_y</span><span class="p">)[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">si</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">ti</span><span class="p">(</span>
        <span class="n">frame_data</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">previous_frame_data</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate TI between two frames.</span>

<span class="sd">        Args:</span>
<span class="sd">            frame_data (ndarray): 2D array of current frame data</span>
<span class="sd">            previous_frame_data (ndarray): 2D array of previous frame data, must be of same size as current frame</span>

<span class="sd">        Returns:</span>
<span class="sd">            float: TI, or None if previous frame data is not given</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># TODO: check array dimensions</span>
        <span class="c1"># TODO: check array dimensions equal between both args</span>

        <span class="k">if</span> <span class="n">previous_frame_data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">cast</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">frame_data</span> <span class="o">-</span> <span class="n">previous_frame_data</span><span class="p">)</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">eotf_1886</span><span class="p">(</span>
        <span class="n">frame_data</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
        <span class="n">gamma</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">DEFAULT_GAMMA</span><span class="p">,</span>
        <span class="n">l_min</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span>
        <span class="n">l_max</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Electro-optical transfer function defined in ITU-R Rec. BT.1886</span>

<span class="sd">        Args:</span>
<span class="sd">            frame_data: pixel values expected in the range [0, 1]</span>
<span class="sd">            gamma: exponent</span>
<span class="sd">            l_min: minimum luminance</span>
<span class="sd">            l_max: maximum luminance</span>
<span class="sd">        Note:</span>
<span class="sd">            As the mapping to display luminance happens outside of this function, l_min and l_max are set to 0.0 and 1.0,</span>
<span class="sd">            respectively. If you change these values while using this function in the context of SI/TI calculation, your</span>
<span class="sd">            output will be wrong. You can however change the values when using this function in a standalone fashion.</span>

<span class="sd">        Returns:</span>
<span class="sd">            frame_data: pixel values in the range [0, 1]</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">frame_data</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Input for eotf_1886() was &lt; 0, truncating&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">frame_data</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Input for eotf_1886() was &gt; 1, truncating&quot;</span><span class="p">)</span>

        <span class="n">frame_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">frame_data</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
        <span class="n">frame_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">frame_data</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>

        <span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">l_max</span><span class="p">,</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">gamma</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">l_min</span><span class="p">,</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">gamma</span><span class="p">),</span> <span class="n">gamma</span><span class="p">)</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">l_min</span><span class="p">,</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">gamma</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">l_max</span><span class="p">,</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">gamma</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">l_min</span><span class="p">,</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">gamma</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="n">frame_data</span> <span class="o">=</span> <span class="n">a</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">frame_data</span> <span class="o">+</span> <span class="n">b</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">gamma</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">frame_data</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">eotf_inv_srgb</span><span class="p">(</span><span class="n">frame_data</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Inverse sRGB electro-optical transfer function</span>

<span class="sd">        Args:</span>
<span class="sd">            frame_data: pixel values expected in the range [0, 1]</span>

<span class="sd">        Returns:</span>
<span class="sd">            frame_data: pixel values in the range [0, 1]</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">frame_data</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Input for eotf_inv_srgb() was &lt; 0, truncating&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">frame_data</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Input for eotf_inv_srgb() was &gt; 1, truncating&quot;</span><span class="p">)</span>

        <span class="n">frame_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">frame_data</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
        <span class="n">frame_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">frame_data</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>

        <span class="n">frame_data</span> <span class="o">=</span> <span class="p">(</span><span class="n">frame_data</span> <span class="o">&lt;=</span> <span class="mf">0.04045</span><span class="p">)</span> <span class="o">*</span> <span class="n">frame_data</span> <span class="o">/</span> <span class="mf">12.92</span> <span class="o">+</span> <span class="p">(</span>
            <span class="n">frame_data</span> <span class="o">&gt;</span> <span class="mf">0.04045</span>
        <span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">((</span><span class="n">frame_data</span> <span class="o">+</span> <span class="mf">0.055</span><span class="p">)</span> <span class="o">/</span> <span class="mf">1.055</span><span class="p">,</span> <span class="mf">2.4</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">frame_data</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">apply_display_model</span><span class="p">(</span>
        <span class="n">frame_data</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
        <span class="n">eotf_function</span><span class="p">:</span> <span class="n">EotfFunction</span> <span class="o">=</span> <span class="n">EotfFunction</span><span class="o">.</span><span class="n">BT1886</span><span class="p">,</span>
        <span class="n">l_max</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">DEFAULT_L_MAX</span><span class="p">,</span>
        <span class="n">l_min</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">DEFAULT_L_MIN</span><span class="p">,</span>
        <span class="n">gamma</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">DEFAULT_GAMMA</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Apply the SDR EOTF</span>

<span class="sd">        Args:</span>
<span class="sd">            frame_data (np.ndarray): Raw frame data in full range, values in the range [0, 1]</span>
<span class="sd">            Other arguments: see calculate()</span>

<span class="sd">        Returns:</span>
<span class="sd">            frame_data: pixel values in the physical domain.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">frame_data</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Input for apply_display_model() was &lt; 0&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">frame_data</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Input for apply_display_model() was &gt; 1&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">eotf_function</span> <span class="o">==</span> <span class="n">EotfFunction</span><span class="o">.</span><span class="n">BT1886</span><span class="p">:</span>
            <span class="n">fn</span> <span class="o">=</span> <span class="n">SiTiCalculator</span><span class="o">.</span><span class="n">eotf_1886</span>
            <span class="c1"># note that l_min/l_max are not passed here on purpose, as they are set to 0.0 and 1.0,</span>
            <span class="c1"># and mapped outside of the eotf_1886 function</span>
            <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;gamma&quot;</span><span class="p">:</span> <span class="n">gamma</span><span class="p">}</span>
        <span class="k">elif</span> <span class="n">eotf_function</span> <span class="o">==</span> <span class="n">EotfFunction</span><span class="o">.</span><span class="n">INV_SRGB</span><span class="p">:</span>
            <span class="n">fn</span> <span class="o">=</span> <span class="n">SiTiCalculator</span><span class="o">.</span><span class="n">eotf_inv_srgb</span>
            <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Unknown EOTF function!&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">(</span><span class="n">l_max</span> <span class="o">-</span> <span class="n">l_min</span><span class="p">)</span> <span class="o">*</span> <span class="n">fn</span><span class="p">(</span><span class="n">frame_data</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">+</span> <span class="n">l_min</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">oetf_pq</span><span class="p">(</span><span class="n">frame_data</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Perceptual quantizer opto-electrical transfer function defined in ITU-R Rec. BT.2100</span>

<span class="sd">        Args:</span>
<span class="sd">            frame_data: pixel values expected to be in the physical luminance between 0 and 10,000 cd/m^2</span>

<span class="sd">        Returns:</span>
<span class="sd">            frame_data: pixel values in the range [0, 1]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">m</span> <span class="o">=</span> <span class="mf">78.84375</span>
        <span class="n">n</span> <span class="o">=</span> <span class="mf">0.1593017578125</span>
        <span class="n">c1</span> <span class="o">=</span> <span class="mf">0.8359375</span>
        <span class="n">c2</span> <span class="o">=</span> <span class="mf">18.8515625</span>
        <span class="n">c3</span> <span class="o">=</span> <span class="mf">18.6875</span>
        <span class="n">lm1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="mf">10000.0</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
        <span class="c1"># FIXME: this might return an error if input is negative, see https://stackoverflow.com/q/45384602/</span>
        <span class="n">lm2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">frame_data</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>

        <span class="n">frame_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">((</span><span class="n">c1</span> <span class="o">*</span> <span class="n">lm1</span> <span class="o">+</span> <span class="n">c2</span> <span class="o">*</span> <span class="n">lm2</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">lm1</span> <span class="o">+</span> <span class="n">c3</span> <span class="o">*</span> <span class="n">lm2</span><span class="p">),</span> <span class="n">m</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">frame_data</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">oetf_pu21</span><span class="p">(</span>
        <span class="n">frame_data</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
        <span class="n">mode</span><span class="p">:</span> <span class="n">Pu21Mode</span> <span class="o">=</span> <span class="n">Pu21Mode</span><span class="o">.</span><span class="n">BANDING</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        PU21 OETF, see https://github.com/gfxdisp/pu21</span>

<span class="sd">        Args:</span>
<span class="sd">            frame_data (np.ndarray): Raw frame data in full range, values in the range [0, 1]</span>
<span class="sd">            mode (Pu21Mode), defaults to Pu21Mode.BANDING</span>

<span class="sd">        Returns:</span>
<span class="sd">            frame_data: pixel values in the range [0, 1]</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;banding&quot;</span><span class="p">:</span>
            <span class="n">p</span> <span class="o">=</span> <span class="p">[</span>
                <span class="mf">1.070275272</span><span class="p">,</span>
                <span class="mf">0.4088273932</span><span class="p">,</span>
                <span class="mf">0.153224308</span><span class="p">,</span>
                <span class="mf">0.2520326168</span><span class="p">,</span>
                <span class="mf">1.063512885</span><span class="p">,</span>
                <span class="mf">1.14115047</span><span class="p">,</span>
                <span class="mf">521.4527484</span><span class="p">,</span>
            <span class="p">]</span>
            <span class="n">p_min</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.5580e-07</span>
            <span class="n">p_max</span> <span class="o">=</span> <span class="mf">520.4673</span>
        <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;banding_glare&quot;</span><span class="p">:</span>
            <span class="n">p</span> <span class="o">=</span> <span class="p">[</span>
                <span class="mf">0.353487901</span><span class="p">,</span>
                <span class="mf">0.3734658629</span><span class="p">,</span>
                <span class="mf">8.277049286e-05</span><span class="p">,</span>
                <span class="mf">0.9062562627</span><span class="p">,</span>
                <span class="mf">0.09150303166</span><span class="p">,</span>
                <span class="mf">0.9099517204</span><span class="p">,</span>
                <span class="mf">596.3148142</span><span class="p">,</span>
            <span class="p">]</span>
            <span class="n">p_min</span> <span class="o">=</span> <span class="mf">5.4705e-10</span>
            <span class="n">p_max</span> <span class="o">=</span> <span class="mf">595.3939</span>
        <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;peaks&quot;</span><span class="p">:</span>
            <span class="n">p</span> <span class="o">=</span> <span class="p">[</span>
                <span class="mf">1.043882782</span><span class="p">,</span>
                <span class="mf">0.6459495343</span><span class="p">,</span>
                <span class="mf">0.3194584211</span><span class="p">,</span>
                <span class="mf">0.374025247</span><span class="p">,</span>
                <span class="mf">1.114783422</span><span class="p">,</span>
                <span class="mf">1.095360363</span><span class="p">,</span>
                <span class="mf">384.9217577</span><span class="p">,</span>
            <span class="p">]</span>
            <span class="n">p_min</span> <span class="o">=</span> <span class="mf">1.3674e-07</span>
            <span class="n">p_max</span> <span class="o">=</span> <span class="mf">380.9853</span>
        <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;peaks_glare&quot;</span><span class="p">:</span>
            <span class="n">p</span> <span class="o">=</span> <span class="p">[</span>
                <span class="mf">816.885024</span><span class="p">,</span>
                <span class="mf">1479.463946</span><span class="p">,</span>
                <span class="mf">0.001253215609</span><span class="p">,</span>
                <span class="mf">0.9329636822</span><span class="p">,</span>
                <span class="mf">0.06746643971</span><span class="p">,</span>
                <span class="mf">1.573435413</span><span class="p">,</span>
                <span class="mf">419.6006374</span><span class="p">,</span>
            <span class="p">]</span>
            <span class="n">p_min</span> <span class="o">=</span> <span class="o">-</span><span class="mf">9.7360e-08</span>
            <span class="n">p_max</span> <span class="o">=</span> <span class="mf">407.5066</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Invalid mode specified for PU21&quot;</span><span class="p">)</span>

        <span class="c1"># scale frame_data to the range 0.005 - 10,000</span>
        <span class="c1"># disabled since the input is already in physical luminance</span>
        <span class="c1"># frame_data = frame_data * 10000.0</span>
        <span class="c1"># frame_data = np.maximum(frame_data, 0.05)</span>

        <span class="n">frame_data</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span>
                <span class="p">(</span>
                    <span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">frame_data</span><span class="p">,</span> <span class="n">p</span><span class="p">[</span><span class="mi">3</span><span class="p">]))</span>
                    <span class="o">/</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="n">p</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">frame_data</span><span class="p">,</span> <span class="n">p</span><span class="p">[</span><span class="mi">3</span><span class="p">]))</span>
                <span class="p">),</span>
                <span class="n">p</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span>
            <span class="p">)</span>
            <span class="o">-</span> <span class="n">p</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>
        <span class="p">)</span>

        <span class="c1"># get the output into the range [0, 1]</span>
        <span class="n">frame_data</span> <span class="o">=</span> <span class="p">(</span><span class="n">frame_data</span> <span class="o">-</span> <span class="n">p_min</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">p_max</span> <span class="o">-</span> <span class="n">p_min</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">frame_data</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">eotf_hlg</span><span class="p">(</span>
        <span class="n">frame_data</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
        <span class="n">l_min</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">DEFAULT_L_MIN_HDR</span><span class="p">,</span>
        <span class="n">l_max</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">DEFAULT_L_MAX_HDR</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Hybrid log-gamma opto-electrical transfer function defined in ITU-T Rec. BT.2100</span>

<span class="sd">        Args:</span>
<span class="sd">            frame_data: pixel values expected to be in the range [0, 1]</span>

<span class="sd">        Returns:</span>
<span class="sd">            frame_data: pixel values in the physical luminance up to 10,000 cd/m^2</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">frame_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">frame_data</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
        <span class="n">frame_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">frame_data</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>

        <span class="n">a</span> <span class="o">=</span> <span class="mf">0.17883277</span>
        <span class="n">b</span> <span class="o">=</span> <span class="mf">0.02372241</span>
        <span class="n">c</span> <span class="o">=</span> <span class="mf">1.00429347</span>
        <span class="n">gamma</span> <span class="o">=</span> <span class="mf">1.2</span>

        <span class="n">frame_data</span> <span class="o">=</span> <span class="p">(</span><span class="n">frame_data</span> <span class="o">&lt;=</span> <span class="mf">0.5</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">frame_data</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">)</span> <span class="o">/</span> <span class="mf">3.0</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span>
            <span class="n">frame_data</span> <span class="o">&gt;</span> <span class="mf">0.5</span>
        <span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">((</span><span class="n">frame_data</span> <span class="o">-</span> <span class="n">c</span><span class="p">)</span> <span class="o">/</span> <span class="n">a</span><span class="p">)</span> <span class="o">-</span> <span class="n">b</span><span class="p">)</span>

        <span class="n">frame_data</span> <span class="o">=</span> <span class="p">(</span><span class="n">l_max</span> <span class="o">-</span> <span class="n">l_min</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">frame_data</span><span class="p">,</span> <span class="n">gamma</span> <span class="o">-</span> <span class="mf">1.0</span><span class="p">)</span> <span class="o">+</span> <span class="n">l_min</span>

        <span class="k">return</span> <span class="n">frame_data</span>

    <span class="k">def</span> <span class="nf">normalize_to_original_range</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frame_data</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="nb">float</span><span class="p">]):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Normalize frame data in the range [0, 1] to their original range, based on</span>
<span class="sd">        bit depth, e.g. from [0, 1] to [0, 255].</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">frame_data</span> <span class="o">*</span> <span class="p">(</span><span class="mi">2</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">bit_depth</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">normalize_to_original_si_range</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frame_data</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="nb">float</span><span class="p">]):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Normalize frame data in the range [0, 1] to [0, 255], which was the original</span>
<span class="sd">        range for SI/TI.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">frame_data</span> <span class="o">*</span> <span class="p">(</span><span class="mi">2</span><span class="o">**</span><span class="mi">8</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">normalize_between_0_1</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frame_data</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="nb">float</span><span class="p">]):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Normalize frame data in the range [0, x] to [0, 1], based on bit depth.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">frame_data</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">bit_depth</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">add_frame_callback</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">callback_fn</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">float</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="kc">None</span><span class="p">],</span> <span class="nb">int</span><span class="p">],</span> <span class="kc">None</span><span class="p">]</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add a function that gets called whenever a frame&#39;s values are available</span>

<span class="sd">        Args:</span>
<span class="sd">            callback_fn (Callable[[float, Union[float, None], int], None]): The function that should get called. It will receive SI, TI and the frame number.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">callbacks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">callback_fn</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">handle_limited_range</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frame_data</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Transforms data from limited range to full range. We expect the input to be in [16/255, 235/255] already.</span>
<span class="sd">        Apply this to limited range content only! If we exceed the limited range, an error will be raised.</span>

<span class="sd">        Args:</span>
<span class="sd">            frame_data (np.ndarray): The frame data in limited range.</span>

<span class="sd">        Returns:</span>
<span class="sd">            frame_data: The frame data in full range between [0, 1].</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">input_min</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">frame_data</span><span class="p">)</span>
        <span class="n">input_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">frame_data</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">input_min</span> <span class="o">+</span> <span class="mf">0.001</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">LIMITED_RANGE_MIN</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span>
            <span class="n">input_max</span> <span class="o">-</span> <span class="mf">0.001</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">LIMITED_RANGE_MAX</span>
        <span class="p">):</span>
            <span class="c1"># inform the user about the original range</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                <span class="s2">&quot;Input appears to be full range, but it is treated as limited range SDR! &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;Input range is [</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">normalize_to_original_range</span><span class="p">(</span><span class="n">input_min</span><span class="p">))</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">normalize_to_original_range</span><span class="p">(</span><span class="n">input_max</span><span class="p">))</span><span class="si">}</span><span class="s2">]. &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;Expected range for limited content [</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">normalize_to_original_range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">LIMITED_RANGE_MIN</span><span class="p">))</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">normalize_to_original_range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">LIMITED_RANGE_MAX</span><span class="p">))</span><span class="si">}</span><span class="s2">]. &quot;</span>
                <span class="s2">&quot;Specify the range as full instead.&quot;</span>
            <span class="p">)</span>
        <span class="c1"># scale up to full range</span>
        <span class="n">frame_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span>
            <span class="p">(</span><span class="n">frame_data</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">LIMITED_RANGE_MIN</span><span class="p">)</span>
            <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">LIMITED_RANGE_MAX</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">LIMITED_RANGE_MIN</span><span class="p">),</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">frame_data</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">plot_histogram</span><span class="p">(</span><span class="n">frame_data</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">plotille</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span>
            <span class="n">frame_data</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">bins</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">78</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span> <span class="n">x_min</span><span class="o">=</span><span class="mi">0</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">calculate</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">input_file</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">num_frames</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span> <span class="n">List</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="kc">None</span><span class="p">]],</span> <span class="nb">int</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Calculate SI and TI from an input file.</span>

<span class="sd">        Returns two arrays and one integer, the first array being the SI values, the</span>
<span class="sd">        second array being the TI values. The first element of the TI value array will</span>
<span class="sd">        always be 0. The integer will be equal to the number of frames read.</span>

<span class="sd">        You can also get the results later via .get_results()</span>

<span class="sd">        Args:</span>
<span class="sd">            input_file (str): input file path</span>
<span class="sd">            num_frames (int): number of frames to calculate. Defaults to 0 (unlimited).</span>

<span class="sd">        Returns:</span>
<span class="sd">            [[float], [float|None], int]: [si_values], [ti_values], frame count</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">si_values</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ti_values</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">last_input_file</span> <span class="o">=</span> <span class="n">input_file</span>
        <span class="n">previous_frame_data</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">current_frame</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">frame_data</span> <span class="ow">in</span> <span class="n">read_container</span><span class="p">(</span><span class="n">input_file</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="ow">and</span> <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Frame </span><span class="si">{</span><span class="n">current_frame</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">current_frame</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Original frame data&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_log_frame_data</span><span class="p">(</span><span class="n">frame_data</span><span class="p">)</span>

            <span class="c1"># Normalize frame data according to bit depth between 0 and 1.</span>
            <span class="c1"># This will transform [0, 255] to [0, 1], and [0, 1023] to [0, 1] etc.</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">legacy</span><span class="p">:</span>
                <span class="n">frame_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">normalize_between_0_1</span><span class="p">(</span><span class="n">frame_data</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">current_frame</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Frame data after normalization between 0 and 1&quot;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_log_frame_data</span><span class="p">(</span><span class="n">frame_data</span><span class="p">)</span>

                <span class="c1"># convert limited to full range</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">color_range</span> <span class="o">==</span> <span class="n">ColorRange</span><span class="o">.</span><span class="n">LIMITED</span><span class="p">:</span>
                    <span class="n">frame_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">handle_limited_range</span><span class="p">(</span><span class="n">frame_data</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">current_frame</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Frame data after limited-range normalization&quot;</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_log_frame_data</span><span class="p">(</span><span class="n">frame_data</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># in full range, we do not have to further process the data</span>
                    <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">color_range</span> <span class="o">==</span> <span class="n">ColorRange</span><span class="o">.</span><span class="n">LIMITED</span><span class="p">:</span>
                    <span class="c1"># legacy mode, apply the old way of normalizing data between 16-235</span>
                    <span class="n">input_min</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">frame_data</span><span class="p">)</span>
                    <span class="n">input_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">frame_data</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">input_min</span> <span class="o">&lt;</span> <span class="mi">16</span> <span class="ow">or</span> <span class="n">input_max</span> <span class="o">&gt;</span> <span class="mi">235</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;Input appears to be full range ([</span><span class="si">{</span><span class="n">input_min</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">input_max</span><span class="si">}</span><span class="s2">]), specify --color-range=full!&quot;</span>
                        <span class="p">)</span>
                    <span class="c1"># convert to grey by assumng limited range input</span>
                    <span class="n">frame_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">((</span><span class="n">frame_data</span> <span class="o">-</span> <span class="mi">16</span><span class="p">)</span> <span class="o">/</span> <span class="p">((</span><span class="mi">235</span> <span class="o">-</span> <span class="mi">16</span><span class="p">)</span> <span class="o">/</span> <span class="mi">255</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># in full range, we do not have to further process the data</span>
                    <span class="k">pass</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">legacy</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hdr_mode</span> <span class="o">==</span> <span class="n">HdrMode</span><span class="o">.</span><span class="n">SDR</span><span class="p">:</span>
                    <span class="n">frame_data</span> <span class="o">=</span> <span class="n">SiTiCalculator</span><span class="o">.</span><span class="n">apply_display_model</span><span class="p">(</span>
                        <span class="n">frame_data</span><span class="p">,</span>
                        <span class="n">eotf_function</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">eotf_function</span><span class="p">,</span>
                        <span class="n">l_max</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">l_max</span><span class="p">,</span>
                        <span class="n">l_min</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">l_min</span><span class="p">,</span>
                        <span class="n">gamma</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gamma</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="k">if</span> <span class="n">current_frame</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;Frame data after apply_display_model for SDR (</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">l_min</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">l_max</span><span class="si">}</span><span class="s2">)&quot;</span>
                        <span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_log_frame_data</span><span class="p">(</span><span class="n">frame_data</span><span class="p">)</span>
                    <span class="n">frame_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">oetf_function</span><span class="p">(</span>
                        <span class="n">frame_data</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">oetf_function_kwargs</span>
                    <span class="p">)</span>
                    <span class="k">if</span> <span class="n">current_frame</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;Frame data after OETF function </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">oetf_function</span><span class="si">}</span><span class="s2"> with args </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">oetf_function_kwargs</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_log_frame_data</span><span class="p">(</span><span class="n">frame_data</span><span class="p">)</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">hdr_mode</span> <span class="o">==</span> <span class="n">HdrMode</span><span class="o">.</span><span class="n">HDR10</span><span class="p">:</span>
                    <span class="c1"># nothing to do, we are already in PQ domain</span>
                    <span class="c1"># TODO allow using Pu21 here?</span>
                    <span class="k">pass</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">hdr_mode</span> <span class="o">==</span> <span class="n">HdrMode</span><span class="o">.</span><span class="n">HLG</span><span class="p">:</span>
                    <span class="n">frame_data</span> <span class="o">=</span> <span class="n">SiTiCalculator</span><span class="o">.</span><span class="n">eotf_hlg</span><span class="p">(</span>
                        <span class="n">frame_data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">l_min</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">l_max</span>
                    <span class="p">)</span>
                    <span class="k">if</span> <span class="n">current_frame</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;Frame data after eotf_hlg for HLG with l_min/l_max settings </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">l_min</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">l_max</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_log_frame_data</span><span class="p">(</span><span class="n">frame_data</span><span class="p">)</span>
                    <span class="n">frame_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">oetf_function</span><span class="p">(</span>
                        <span class="n">frame_data</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">oetf_function_kwargs</span>
                    <span class="p">)</span>
                    <span class="k">if</span> <span class="n">current_frame</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;Frame data after OETF function </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">oetf_function</span><span class="si">}</span><span class="s2"> with args </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">oetf_function_kwargs</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_log_frame_data</span><span class="p">(</span><span class="n">frame_data</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid HDR mode &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">hdr_mode</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">legacy</span><span class="p">:</span>
                <span class="n">si_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">normalize_to_original_si_range</span><span class="p">(</span>
                    <span class="n">SiTiCalculator</span><span class="o">.</span><span class="n">si</span><span class="p">(</span><span class="n">frame_data</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">si_value</span> <span class="o">=</span> <span class="n">SiTiCalculator</span><span class="o">.</span><span class="n">si</span><span class="p">(</span><span class="n">frame_data</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">current_frame</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">legacy</span><span class="p">:</span>
                    <span class="n">ti_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">normalize_to_original_si_range</span><span class="p">(</span>
                        <span class="n">cast</span><span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="n">SiTiCalculator</span><span class="o">.</span><span class="n">ti</span><span class="p">(</span><span class="n">frame_data</span><span class="p">,</span> <span class="n">previous_frame_data</span><span class="p">))</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">ti_value</span> <span class="o">=</span> <span class="n">SiTiCalculator</span><span class="o">.</span><span class="n">ti</span><span class="p">(</span><span class="n">frame_data</span><span class="p">,</span> <span class="n">previous_frame_data</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ti_value</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;SI value </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="n">SiTiCalculator</span><span class="o">.</span><span class="n">si</span><span class="p">(</span><span class="n">frame_data</span><span class="p">),</span> <span class="mi">3</span><span class="p">)</span><span class="si">}</span><span class="s2">, normalized: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">normalize_to_original_si_range</span><span class="p">(</span><span class="n">SiTiCalculator</span><span class="o">.</span><span class="n">si</span><span class="p">(</span><span class="n">frame_data</span><span class="p">)),</span> <span class="mi">3</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">ti_value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;TI value </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="n">cast</span><span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="n">SiTiCalculator</span><span class="o">.</span><span class="n">ti</span><span class="p">(</span><span class="n">frame_data</span><span class="p">,</span> <span class="n">previous_frame_data</span><span class="p">)),</span> <span class="mi">3</span><span class="p">)</span><span class="si">}</span><span class="s2">, normalized: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">normalize_to_original_si_range</span><span class="p">(</span><span class="n">cast</span><span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="n">SiTiCalculator</span><span class="o">.</span><span class="n">ti</span><span class="p">(</span><span class="n">frame_data</span><span class="p">,</span> <span class="n">previous_frame_data</span><span class="p">))),</span> <span class="mi">3</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">si_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cast</span><span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="n">si_value</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">ti_value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ti_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cast</span><span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="n">ti_value</span><span class="p">))</span>

            <span class="n">previous_frame_data</span> <span class="o">=</span> <span class="n">frame_data</span>

            <span class="n">current_frame</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="k">for</span> <span class="n">callback</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">callbacks</span><span class="p">:</span>
                <span class="n">callback</span><span class="p">(</span><span class="n">si_value</span><span class="p">,</span> <span class="n">ti_value</span><span class="p">,</span> <span class="n">current_frame</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">num_frames</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="ow">and</span> <span class="n">current_frame</span> <span class="o">&gt;=</span> <span class="n">num_frames</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">si_values</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ti_values</span><span class="p">,</span> <span class="n">current_frame</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">si_values</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ti_values</span><span class="p">,</span> <span class="n">current_frame</span>

    <span class="k">def</span> <span class="nf">get_csv_results</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a CSV string with the results.</span>

<span class="sd">        Note that this does not output all data. Also, the first TI value will be output as &quot;None&quot;.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># prepend a zero here</span>
        <span class="n">ti_values_to_output</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">ti_values</span><span class="p">]</span>

        <span class="n">output</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">StringIO</span><span class="p">()</span>
        <span class="n">writer</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">DictWriter</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="n">fieldnames</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;input_file&quot;</span><span class="p">,</span> <span class="s2">&quot;n&quot;</span><span class="p">,</span> <span class="s2">&quot;si&quot;</span><span class="p">,</span> <span class="s2">&quot;ti&quot;</span><span class="p">])</span>
        <span class="n">writer</span><span class="o">.</span><span class="n">writeheader</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="p">(</span><span class="n">si_value</span><span class="p">,</span> <span class="n">ti_value</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span>
            <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">si_values</span><span class="p">,</span> <span class="n">ti_values_to_output</span><span class="p">)</span>
        <span class="p">):</span>
            <span class="n">writer</span><span class="o">.</span><span class="n">writerow</span><span class="p">(</span>
                <span class="p">{</span>
                    <span class="s2">&quot;input_file&quot;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">last_input_file</span><span class="p">)</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_input_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                    <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;n&quot;</span><span class="p">:</span> <span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
                    <span class="s2">&quot;si&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">si_value</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>
                    <span class="s2">&quot;ti&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">ti_value</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="k">if</span> <span class="n">ti_value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
                <span class="p">}</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">output</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">get_results</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get a JSON-serializable result dictionary with SI, TI values, as well as used settings.</span>

<span class="sd">        Returns:</span>
<span class="sd">            dict: A dictionary containing &quot;si&quot;, &quot;ti&quot; arrays, &quot;settings&quot; as a dict, and the &quot;input_file&quot; name.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;si&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">si_values</span><span class="p">,</span>
            <span class="s2">&quot;ti&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">ti_values</span><span class="p">,</span>
            <span class="s2">&quot;settings&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_general_settings</span><span class="p">(),</span>
            <span class="s2">&quot;input_file&quot;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">last_input_file</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_input_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">_log_frame_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frame_data</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;  [</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">frame_data</span><span class="p">),</span> <span class="mi">3</span><span class="p">)</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">frame_data</span><span class="p">),</span> <span class="mi">3</span><span class="p">)</span><span class="si">}</span><span class="s2">], mean </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">frame_data</span><span class="p">),</span> <span class="mi">3</span><span class="p">)</span><span class="si">}</span><span class="s2">, median </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">frame_data</span><span class="p">),</span> <span class="mi">3</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_histogram</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">SiTiCalculator</span><span class="o">.</span><span class="n">plot_histogram</span><span class="p">(</span><span class="n">frame_data</span><span class="p">))</span>
</pre></div>

        </details>

            </section>
                <section id="EnumArg">
                                <div class="attr class">
        <a class="headerlink" href="#EnumArg">#&nbsp;&nbsp</a>

        
        <span class="def">class</span>
        <span class="name">EnumArg</span>(<span class="base">enum.Enum</span>):
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span><span class="k">class</span> <span class="nc">EnumArg</span><span class="p">(</span><span class="n">Enum</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span>
</pre></div>

        </details>

            <div class="docstring"><p>An enumeration.</p>
</div>


                            <div id="EnumArg.__init__" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#EnumArg.__init__">#&nbsp;&nbsp</a>

        
            <span class="name">EnumArg</span><span class="signature">()</span>    </div>

        
    

                            </div>
                            <div class="inherited">
                                <h5>Inherited Members</h5>
                                <dl>
                                    <div><dt>enum.Enum</dt>
                                <dd id="EnumArg.name" class="variable">name</dd>
                <dd id="EnumArg.value" class="variable">value</dd>

            </div>
                                </dl>
                            </div>
                </section>
                <section id="HdrMode">
                                <div class="attr class">
        <a class="headerlink" href="#HdrMode">#&nbsp;&nbsp</a>

        
        <span class="def">class</span>
        <span class="name">HdrMode</span>(<span class="base"><a href="#EnumArg">EnumArg</a></span>):
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span><span class="k">class</span> <span class="nc">HdrMode</span><span class="p">(</span><span class="n">EnumArg</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Mode of HDR calculation, should be SDR by default</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">SDR</span> <span class="o">=</span> <span class="s2">&quot;sdr&quot;</span>
    <span class="n">HDR10</span> <span class="o">=</span> <span class="s2">&quot;hdr10&quot;</span>
    <span class="n">HLG</span> <span class="o">=</span> <span class="s2">&quot;hlg&quot;</span>
</pre></div>

        </details>

            <div class="docstring"><p>Mode of HDR calculation, should be SDR by default</p>
</div>


                            <div id="HdrMode.__init__" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#HdrMode.__init__">#&nbsp;&nbsp</a>

        
            <span class="name">HdrMode</span><span class="signature">()</span>    </div>

        
    

                            </div>
                            <div id="HdrMode.SDR" class="classattr">
                                            <div class="attr variable"><a class="headerlink" href="#HdrMode.SDR">#&nbsp;&nbsp</a>

        <span class="name">SDR</span><span class="default_value"> = &lt;<a href="#HdrMode.SDR">HdrMode.SDR</a>: &#39;sdr&#39;&gt;</span>
    </div>

    

                            </div>
                            <div id="HdrMode.HDR10" class="classattr">
                                            <div class="attr variable"><a class="headerlink" href="#HdrMode.HDR10">#&nbsp;&nbsp</a>

        <span class="name">HDR10</span><span class="default_value"> = &lt;<a href="#HdrMode.HDR10">HdrMode.HDR10</a>: &#39;hdr10&#39;&gt;</span>
    </div>

    

                            </div>
                            <div id="HdrMode.HLG" class="classattr">
                                            <div class="attr variable"><a class="headerlink" href="#HdrMode.HLG">#&nbsp;&nbsp</a>

        <span class="name">HLG</span><span class="default_value"> = &lt;<a href="#HdrMode.HLG">HdrMode.HLG</a>: &#39;hlg&#39;&gt;</span>
    </div>

    

                            </div>
                            <div class="inherited">
                                <h5>Inherited Members</h5>
                                <dl>
                                    <div><dt>enum.Enum</dt>
                                <dd id="HdrMode.name" class="variable">name</dd>
                <dd id="HdrMode.value" class="variable">value</dd>

            </div>
                                </dl>
                            </div>
                </section>
                <section id="ColorRange">
                                <div class="attr class">
        <a class="headerlink" href="#ColorRange">#&nbsp;&nbsp</a>

        
        <span class="def">class</span>
        <span class="name">ColorRange</span>(<span class="base"><a href="#EnumArg">EnumArg</a></span>):
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span><span class="k">class</span> <span class="nc">ColorRange</span><span class="p">(</span><span class="n">EnumArg</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Limited or full range, where limited is from 16-235, and full is from 0-255.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">LIMITED</span> <span class="o">=</span> <span class="s2">&quot;limited&quot;</span>
    <span class="n">FULL</span> <span class="o">=</span> <span class="s2">&quot;full&quot;</span>
</pre></div>

        </details>

            <div class="docstring"><p>Limited or full range, where limited is from 16-235, and full is from 0-255.</p>
</div>


                            <div id="ColorRange.__init__" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#ColorRange.__init__">#&nbsp;&nbsp</a>

        
            <span class="name">ColorRange</span><span class="signature">()</span>    </div>

        
    

                            </div>
                            <div id="ColorRange.LIMITED" class="classattr">
                                            <div class="attr variable"><a class="headerlink" href="#ColorRange.LIMITED">#&nbsp;&nbsp</a>

        <span class="name">LIMITED</span><span class="default_value"> = &lt;<a href="#ColorRange.LIMITED">ColorRange.LIMITED</a>: &#39;limited&#39;&gt;</span>
    </div>

    

                            </div>
                            <div id="ColorRange.FULL" class="classattr">
                                            <div class="attr variable"><a class="headerlink" href="#ColorRange.FULL">#&nbsp;&nbsp</a>

        <span class="name">FULL</span><span class="default_value"> = &lt;<a href="#ColorRange.FULL">ColorRange.FULL</a>: &#39;full&#39;&gt;</span>
    </div>

    

                            </div>
                            <div class="inherited">
                                <h5>Inherited Members</h5>
                                <dl>
                                    <div><dt>enum.Enum</dt>
                                <dd id="ColorRange.name" class="variable">name</dd>
                <dd id="ColorRange.value" class="variable">value</dd>

            </div>
                                </dl>
                            </div>
                </section>
                <section id="EotfFunction">
                                <div class="attr class">
        <a class="headerlink" href="#EotfFunction">#&nbsp;&nbsp</a>

        
        <span class="def">class</span>
        <span class="name">EotfFunction</span>(<span class="base"><a href="#EnumArg">EnumArg</a></span>):
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span><span class="k">class</span> <span class="nc">EotfFunction</span><span class="p">(</span><span class="n">EnumArg</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    EOTF for converting SDR</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">BT1886</span> <span class="o">=</span> <span class="s2">&quot;bt1886&quot;</span>
    <span class="n">INV_SRGB</span> <span class="o">=</span> <span class="s2">&quot;inv_srgb&quot;</span>
</pre></div>

        </details>

            <div class="docstring"><p>EOTF for converting SDR</p>
</div>


                            <div id="EotfFunction.__init__" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#EotfFunction.__init__">#&nbsp;&nbsp</a>

        
            <span class="name">EotfFunction</span><span class="signature">()</span>    </div>

        
    

                            </div>
                            <div id="EotfFunction.BT1886" class="classattr">
                                            <div class="attr variable"><a class="headerlink" href="#EotfFunction.BT1886">#&nbsp;&nbsp</a>

        <span class="name">BT1886</span><span class="default_value"> = &lt;<a href="#EotfFunction.BT1886">EotfFunction.BT1886</a>: &#39;bt1886&#39;&gt;</span>
    </div>

    

                            </div>
                            <div id="EotfFunction.INV_SRGB" class="classattr">
                                            <div class="attr variable"><a class="headerlink" href="#EotfFunction.INV_SRGB">#&nbsp;&nbsp</a>

        <span class="name">INV_SRGB</span><span class="default_value"> = &lt;<a href="#EotfFunction.INV_SRGB">EotfFunction.INV_SRGB</a>: &#39;inv_srgb&#39;&gt;</span>
    </div>

    

                            </div>
                            <div class="inherited">
                                <h5>Inherited Members</h5>
                                <dl>
                                    <div><dt>enum.Enum</dt>
                                <dd id="EotfFunction.name" class="variable">name</dd>
                <dd id="EotfFunction.value" class="variable">value</dd>

            </div>
                                </dl>
                            </div>
                </section>
                <section id="CalculationDomain">
                                <div class="attr class">
        <a class="headerlink" href="#CalculationDomain">#&nbsp;&nbsp</a>

        
        <span class="def">class</span>
        <span class="name">CalculationDomain</span>(<span class="base"><a href="#EnumArg">EnumArg</a></span>):
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span><span class="k">class</span> <span class="nc">CalculationDomain</span><span class="p">(</span><span class="n">EnumArg</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Domain in which to calculate SI/TI</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">PQ</span> <span class="o">=</span> <span class="s2">&quot;pq&quot;</span>
    <span class="n">PU21</span> <span class="o">=</span> <span class="s2">&quot;pu21&quot;</span>
</pre></div>

        </details>

            <div class="docstring"><p>Domain in which to calculate SI/TI</p>
</div>


                            <div id="CalculationDomain.__init__" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#CalculationDomain.__init__">#&nbsp;&nbsp</a>

        
            <span class="name">CalculationDomain</span><span class="signature">()</span>    </div>

        
    

                            </div>
                            <div id="CalculationDomain.PQ" class="classattr">
                                            <div class="attr variable"><a class="headerlink" href="#CalculationDomain.PQ">#&nbsp;&nbsp</a>

        <span class="name">PQ</span><span class="default_value"> = &lt;<a href="#CalculationDomain.PQ">CalculationDomain.PQ</a>: &#39;pq&#39;&gt;</span>
    </div>

    

                            </div>
                            <div id="CalculationDomain.PU21" class="classattr">
                                            <div class="attr variable"><a class="headerlink" href="#CalculationDomain.PU21">#&nbsp;&nbsp</a>

        <span class="name">PU21</span><span class="default_value"> = &lt;<a href="#CalculationDomain.PU21">CalculationDomain.PU21</a>: &#39;pu21&#39;&gt;</span>
    </div>

    

                            </div>
                            <div class="inherited">
                                <h5>Inherited Members</h5>
                                <dl>
                                    <div><dt>enum.Enum</dt>
                                <dd id="CalculationDomain.name" class="variable">name</dd>
                <dd id="CalculationDomain.value" class="variable">value</dd>

            </div>
                                </dl>
                            </div>
                </section>
                <section id="Pu21Mode">
                                <div class="attr class">
        <a class="headerlink" href="#Pu21Mode">#&nbsp;&nbsp</a>

        
        <span class="def">class</span>
        <span class="name">Pu21Mode</span>(<span class="base"><a href="#EnumArg">EnumArg</a></span>):
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span><span class="k">class</span> <span class="nc">Pu21Mode</span><span class="p">(</span><span class="n">EnumArg</span><span class="p">):</span>
    <span class="n">BANDING</span> <span class="o">=</span> <span class="s2">&quot;banding&quot;</span>
    <span class="n">BANDING_GLARE</span> <span class="o">=</span> <span class="s2">&quot;banding_glare&quot;</span>
    <span class="n">PEAKS</span> <span class="o">=</span> <span class="s2">&quot;peaks&quot;</span>
    <span class="n">PEAKS_GLARE</span> <span class="o">=</span> <span class="s2">&quot;peaks_glare&quot;</span>
</pre></div>

        </details>

            <div class="docstring"><p>An enumeration.</p>
</div>


                            <div id="Pu21Mode.__init__" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#Pu21Mode.__init__">#&nbsp;&nbsp</a>

        
            <span class="name">Pu21Mode</span><span class="signature">()</span>    </div>

        
    

                            </div>
                            <div id="Pu21Mode.BANDING" class="classattr">
                                            <div class="attr variable"><a class="headerlink" href="#Pu21Mode.BANDING">#&nbsp;&nbsp</a>

        <span class="name">BANDING</span><span class="default_value"> = &lt;<a href="#Pu21Mode.BANDING">Pu21Mode.BANDING</a>: &#39;banding&#39;&gt;</span>
    </div>

    

                            </div>
                            <div id="Pu21Mode.BANDING_GLARE" class="classattr">
                                            <div class="attr variable"><a class="headerlink" href="#Pu21Mode.BANDING_GLARE">#&nbsp;&nbsp</a>

        <span class="name">BANDING_GLARE</span><span class="default_value"> = &lt;<a href="#Pu21Mode.BANDING_GLARE">Pu21Mode.BANDING_GLARE</a>: &#39;banding_glare&#39;&gt;</span>
    </div>

    

                            </div>
                            <div id="Pu21Mode.PEAKS" class="classattr">
                                            <div class="attr variable"><a class="headerlink" href="#Pu21Mode.PEAKS">#&nbsp;&nbsp</a>

        <span class="name">PEAKS</span><span class="default_value"> = &lt;<a href="#Pu21Mode.PEAKS">Pu21Mode.PEAKS</a>: &#39;peaks&#39;&gt;</span>
    </div>

    

                            </div>
                            <div id="Pu21Mode.PEAKS_GLARE" class="classattr">
                                            <div class="attr variable"><a class="headerlink" href="#Pu21Mode.PEAKS_GLARE">#&nbsp;&nbsp</a>

        <span class="name">PEAKS_GLARE</span><span class="default_value"> = &lt;<a href="#Pu21Mode.PEAKS_GLARE">Pu21Mode.PEAKS_GLARE</a>: &#39;peaks_glare&#39;&gt;</span>
    </div>

    

                            </div>
                            <div class="inherited">
                                <h5>Inherited Members</h5>
                                <dl>
                                    <div><dt>enum.Enum</dt>
                                <dd id="Pu21Mode.name" class="variable">name</dd>
                <dd id="Pu21Mode.value" class="variable">value</dd>

            </div>
                                </dl>
                            </div>
                </section>
                <section id="SiTiCalculator">
                                <div class="attr class">
        <a class="headerlink" href="#SiTiCalculator">#&nbsp;&nbsp</a>

        
        <span class="def">class</span>
        <span class="name">SiTiCalculator</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span><span class="k">class</span> <span class="nc">SiTiCalculator</span><span class="p">:</span>
    <span class="n">DEFAULT_HDR_MODE</span> <span class="o">=</span> <span class="n">HdrMode</span><span class="o">.</span><span class="n">SDR</span>
    <span class="n">DEFAULT_BIT_DEPTH</span> <span class="o">=</span> <span class="mi">8</span>  <span class="c1"># or 10, 12</span>
    <span class="n">DEFAULT_COLOR_RANGE</span> <span class="o">=</span> <span class="n">ColorRange</span><span class="o">.</span><span class="n">LIMITED</span>
    <span class="n">DEFAULT_EOTF_FUNCTION</span> <span class="o">=</span> <span class="n">EotfFunction</span><span class="o">.</span><span class="n">BT1886</span>
    <span class="n">DEFAULT_CALCULATION_DOMAIN</span> <span class="o">=</span> <span class="n">CalculationDomain</span><span class="o">.</span><span class="n">PQ</span>
    <span class="n">DEFAULT_PU21_MODE</span> <span class="o">=</span> <span class="n">Pu21Mode</span><span class="o">.</span><span class="n">BANDING</span>
    <span class="n">DEFAULT_GAMMA</span> <span class="o">=</span> <span class="mf">2.4</span>  <span class="c1"># for BT.1886</span>
    <span class="n">DEFAULT_L_MIN</span> <span class="o">=</span> <span class="mf">0.1</span>
    <span class="n">DEFAULT_L_MAX</span> <span class="o">=</span> <span class="mi">300</span>
    <span class="n">DEFAULT_L_MIN_HDR</span> <span class="o">=</span> <span class="mf">0.01</span>
    <span class="n">DEFAULT_L_MAX_HDR</span> <span class="o">=</span> <span class="mf">1000.0</span>

    <span class="n">LIMITED_RANGE_MIN</span> <span class="o">=</span> <span class="mi">16</span> <span class="o">/</span> <span class="mi">255</span>
    <span class="n">LIMITED_RANGE_MAX</span> <span class="o">=</span> <span class="mi">235</span> <span class="o">/</span> <span class="mi">255</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">from_settings</span><span class="p">(</span><span class="n">settings</span><span class="p">:</span> <span class="n">Dict</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">SiTiCalculator</span><span class="p">(</span><span class="o">**</span><span class="n">settings</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">hdr_mode</span><span class="p">:</span> <span class="n">HdrMode</span> <span class="o">=</span> <span class="n">DEFAULT_HDR_MODE</span><span class="p">,</span>
        <span class="n">bit_depth</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">DEFAULT_BIT_DEPTH</span><span class="p">,</span>
        <span class="n">color_range</span><span class="p">:</span> <span class="n">ColorRange</span> <span class="o">=</span> <span class="n">DEFAULT_COLOR_RANGE</span><span class="p">,</span>
        <span class="n">eotf_function</span><span class="p">:</span> <span class="n">EotfFunction</span> <span class="o">=</span> <span class="n">DEFAULT_EOTF_FUNCTION</span><span class="p">,</span>
        <span class="n">calculation_domain</span><span class="p">:</span> <span class="n">CalculationDomain</span> <span class="o">=</span> <span class="n">DEFAULT_CALCULATION_DOMAIN</span><span class="p">,</span>
        <span class="n">l_max</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">l_min</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">gamma</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">DEFAULT_GAMMA</span><span class="p">,</span>
        <span class="n">pu21_mode</span><span class="p">:</span> <span class="n">Pu21Mode</span> <span class="o">=</span> <span class="n">DEFAULT_PU21_MODE</span><span class="p">,</span>
        <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">show_histogram</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">legacy</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a new SI/TI calculator</span>

<span class="sd">        Args:</span>
<span class="sd">            hdr_mode (HdrMode, optional): Select SDR, HDR10 or HLG. Defaults to SDR.</span>
<span class="sd">            bit_depth (int, optional): 8, 10 or 12. Defaults to 8.</span>
<span class="sd">            color_range (ColorRange, optional): Set the color range (limited or full). Defaults to limited.</span>
<span class="sd">            eotf_function (EotfFunction, optional): EOTF function for converting SDR to HDR. Defaults to BT.1886.</span>
<span class="sd">            calculation_domain (CalculationDomain, optional): Domain to calculate SI/TI in. Defaults to PQ.</span>
<span class="sd">            l_max (float, optional): Set the peak display luminance in cd/m2. Defaults to 300 (SDR) or 1000 (HDR).</span>
<span class="sd">            l_min (float, optional): Set the black display luminance in cd/m2. Defaults to 0.1 (SDR) or 0.01 (HDR).</span>
<span class="sd">            gamma (float, optional): Set the BT.1886 gamma. Defaults to 2.4.</span>
<span class="sd">            pu21_mode (Pu21Mode, optional): Set the default PU21 mode. Defaults to BANDING.</span>
<span class="sd">            verbose (bool, optional): Show verbose logging for the first frame.</span>
<span class="sd">            show_histogram (bool, optional): Show a histogram for the first frame (computation-intensive, implies verbose=True).</span>
<span class="sd">            legacy (bool, optional): Use legacy SI/TI calculation. Defaults to False.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">show_histogram</span> <span class="o">=</span> <span class="n">show_histogram</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">legacy</span> <span class="o">=</span> <span class="n">legacy</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_histogram</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">callbacks</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Callable</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">hdr_mode</span> <span class="o">=</span> <span class="n">hdr_mode</span>

        <span class="k">if</span> <span class="n">bit_depth</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">8</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">12</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Bit depth must be one of 8, 10, 12&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">bit_depth</span> <span class="o">=</span> <span class="n">bit_depth</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">color_range</span> <span class="o">=</span> <span class="n">color_range</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">eotf_function</span> <span class="o">=</span> <span class="n">eotf_function</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">calculation_domain</span> <span class="o">=</span> <span class="n">calculation_domain</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">pu21_mode</span> <span class="o">=</span> <span class="n">pu21_mode</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">oetf_function_kwargs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculation_domain</span> <span class="o">==</span> <span class="n">CalculationDomain</span><span class="o">.</span><span class="n">PQ</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">oetf_function</span> <span class="o">=</span> <span class="n">SiTiCalculator</span><span class="o">.</span><span class="n">oetf_pq</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">oetf_function</span> <span class="o">=</span> <span class="n">SiTiCalculator</span><span class="o">.</span><span class="n">oetf_pu21</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">oetf_function_kwargs</span><span class="p">[</span><span class="s2">&quot;mode&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pu21_mode</span>

        <span class="c1"># overwrite the default depending on HDR type</span>
        <span class="k">if</span> <span class="n">l_max</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">l_max</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">SiTiCalculator</span><span class="o">.</span><span class="n">DEFAULT_L_MAX</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hdr_mode</span> <span class="o">==</span> <span class="n">HdrMode</span><span class="o">.</span><span class="n">SDR</span>
                <span class="k">else</span> <span class="n">SiTiCalculator</span><span class="o">.</span><span class="n">DEFAULT_L_MAX_HDR</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">l_max</span> <span class="o">=</span> <span class="n">l_max</span>
        <span class="k">if</span> <span class="n">l_min</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">l_min</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">SiTiCalculator</span><span class="o">.</span><span class="n">DEFAULT_L_MIN</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hdr_mode</span> <span class="o">==</span> <span class="n">HdrMode</span><span class="o">.</span><span class="n">SDR</span>
                <span class="k">else</span> <span class="n">SiTiCalculator</span><span class="o">.</span><span class="n">DEFAULT_L_MIN_HDR</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">l_min</span> <span class="o">=</span> <span class="n">l_min</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">gamma</span> <span class="o">=</span> <span class="n">gamma</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">si_values</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ti_values</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="kc">None</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">last_input_file</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">get_general_settings</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        A dictionary of settings used for the calculation</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;calculation_domain&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">calculation_domain</span><span class="p">),</span>
            <span class="s2">&quot;hdr_mode&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hdr_mode</span><span class="p">),</span>
            <span class="s2">&quot;bit_depth&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">bit_depth</span><span class="p">,</span>
            <span class="s2">&quot;color_range&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">color_range</span><span class="p">),</span>
            <span class="s2">&quot;eotf_function&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">eotf_function</span><span class="p">),</span>
            <span class="s2">&quot;l_max&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">l_max</span><span class="p">,</span>
            <span class="s2">&quot;l_min&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">l_min</span><span class="p">,</span>
            <span class="s2">&quot;gamma&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">gamma</span><span class="p">,</span>
            <span class="s2">&quot;pu21_mode&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pu21_mode</span><span class="p">),</span>
            <span class="s2">&quot;legacy&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">legacy</span><span class="p">,</span>
            <span class="s2">&quot;version&quot;</span><span class="p">:</span> <span class="n">version</span><span class="p">,</span>
        <span class="p">}</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">si</span><span class="p">(</span><span class="n">frame_data</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Calculate SI of a frame</span>

<span class="sd">        Args:</span>
<span class="sd">            frame_data (ndarray): 2D array of input frame data</span>

<span class="sd">        Returns:</span>
<span class="sd">            float: SI</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># TODO: check array dimensions</span>

        <span class="c1"># calculate horizontal/vertical operators</span>
        <span class="n">sob_x</span> <span class="o">=</span> <span class="n">ndimage</span><span class="o">.</span><span class="n">sobel</span><span class="p">(</span><span class="n">frame_data</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">sob_y</span> <span class="o">=</span> <span class="n">ndimage</span><span class="o">.</span><span class="n">sobel</span><span class="p">(</span><span class="n">frame_data</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># crop output to valid window, calculate gradient magnitude</span>
        <span class="n">si</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hypot</span><span class="p">(</span><span class="n">sob_x</span><span class="p">,</span> <span class="n">sob_y</span><span class="p">)[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">si</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">ti</span><span class="p">(</span>
        <span class="n">frame_data</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">previous_frame_data</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate TI between two frames.</span>

<span class="sd">        Args:</span>
<span class="sd">            frame_data (ndarray): 2D array of current frame data</span>
<span class="sd">            previous_frame_data (ndarray): 2D array of previous frame data, must be of same size as current frame</span>

<span class="sd">        Returns:</span>
<span class="sd">            float: TI, or None if previous frame data is not given</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># TODO: check array dimensions</span>
        <span class="c1"># TODO: check array dimensions equal between both args</span>

        <span class="k">if</span> <span class="n">previous_frame_data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">cast</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">frame_data</span> <span class="o">-</span> <span class="n">previous_frame_data</span><span class="p">)</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">eotf_1886</span><span class="p">(</span>
        <span class="n">frame_data</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
        <span class="n">gamma</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">DEFAULT_GAMMA</span><span class="p">,</span>
        <span class="n">l_min</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span>
        <span class="n">l_max</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Electro-optical transfer function defined in ITU-R Rec. BT.1886</span>

<span class="sd">        Args:</span>
<span class="sd">            frame_data: pixel values expected in the range [0, 1]</span>
<span class="sd">            gamma: exponent</span>
<span class="sd">            l_min: minimum luminance</span>
<span class="sd">            l_max: maximum luminance</span>
<span class="sd">        Note:</span>
<span class="sd">            As the mapping to display luminance happens outside of this function, l_min and l_max are set to 0.0 and 1.0,</span>
<span class="sd">            respectively. If you change these values while using this function in the context of SI/TI calculation, your</span>
<span class="sd">            output will be wrong. You can however change the values when using this function in a standalone fashion.</span>

<span class="sd">        Returns:</span>
<span class="sd">            frame_data: pixel values in the range [0, 1]</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">frame_data</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Input for eotf_1886() was &lt; 0, truncating&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">frame_data</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Input for eotf_1886() was &gt; 1, truncating&quot;</span><span class="p">)</span>

        <span class="n">frame_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">frame_data</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
        <span class="n">frame_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">frame_data</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>

        <span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">l_max</span><span class="p">,</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">gamma</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">l_min</span><span class="p">,</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">gamma</span><span class="p">),</span> <span class="n">gamma</span><span class="p">)</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">l_min</span><span class="p">,</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">gamma</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">l_max</span><span class="p">,</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">gamma</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">l_min</span><span class="p">,</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">gamma</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="n">frame_data</span> <span class="o">=</span> <span class="n">a</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">frame_data</span> <span class="o">+</span> <span class="n">b</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">gamma</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">frame_data</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">eotf_inv_srgb</span><span class="p">(</span><span class="n">frame_data</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Inverse sRGB electro-optical transfer function</span>

<span class="sd">        Args:</span>
<span class="sd">            frame_data: pixel values expected in the range [0, 1]</span>

<span class="sd">        Returns:</span>
<span class="sd">            frame_data: pixel values in the range [0, 1]</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">frame_data</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Input for eotf_inv_srgb() was &lt; 0, truncating&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">frame_data</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Input for eotf_inv_srgb() was &gt; 1, truncating&quot;</span><span class="p">)</span>

        <span class="n">frame_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">frame_data</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
        <span class="n">frame_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">frame_data</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>

        <span class="n">frame_data</span> <span class="o">=</span> <span class="p">(</span><span class="n">frame_data</span> <span class="o">&lt;=</span> <span class="mf">0.04045</span><span class="p">)</span> <span class="o">*</span> <span class="n">frame_data</span> <span class="o">/</span> <span class="mf">12.92</span> <span class="o">+</span> <span class="p">(</span>
            <span class="n">frame_data</span> <span class="o">&gt;</span> <span class="mf">0.04045</span>
        <span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">((</span><span class="n">frame_data</span> <span class="o">+</span> <span class="mf">0.055</span><span class="p">)</span> <span class="o">/</span> <span class="mf">1.055</span><span class="p">,</span> <span class="mf">2.4</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">frame_data</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">apply_display_model</span><span class="p">(</span>
        <span class="n">frame_data</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
        <span class="n">eotf_function</span><span class="p">:</span> <span class="n">EotfFunction</span> <span class="o">=</span> <span class="n">EotfFunction</span><span class="o">.</span><span class="n">BT1886</span><span class="p">,</span>
        <span class="n">l_max</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">DEFAULT_L_MAX</span><span class="p">,</span>
        <span class="n">l_min</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">DEFAULT_L_MIN</span><span class="p">,</span>
        <span class="n">gamma</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">DEFAULT_GAMMA</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Apply the SDR EOTF</span>

<span class="sd">        Args:</span>
<span class="sd">            frame_data (np.ndarray): Raw frame data in full range, values in the range [0, 1]</span>
<span class="sd">            Other arguments: see calculate()</span>

<span class="sd">        Returns:</span>
<span class="sd">            frame_data: pixel values in the physical domain.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">frame_data</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Input for apply_display_model() was &lt; 0&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">frame_data</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Input for apply_display_model() was &gt; 1&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">eotf_function</span> <span class="o">==</span> <span class="n">EotfFunction</span><span class="o">.</span><span class="n">BT1886</span><span class="p">:</span>
            <span class="n">fn</span> <span class="o">=</span> <span class="n">SiTiCalculator</span><span class="o">.</span><span class="n">eotf_1886</span>
            <span class="c1"># note that l_min/l_max are not passed here on purpose, as they are set to 0.0 and 1.0,</span>
            <span class="c1"># and mapped outside of the eotf_1886 function</span>
            <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;gamma&quot;</span><span class="p">:</span> <span class="n">gamma</span><span class="p">}</span>
        <span class="k">elif</span> <span class="n">eotf_function</span> <span class="o">==</span> <span class="n">EotfFunction</span><span class="o">.</span><span class="n">INV_SRGB</span><span class="p">:</span>
            <span class="n">fn</span> <span class="o">=</span> <span class="n">SiTiCalculator</span><span class="o">.</span><span class="n">eotf_inv_srgb</span>
            <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Unknown EOTF function!&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">(</span><span class="n">l_max</span> <span class="o">-</span> <span class="n">l_min</span><span class="p">)</span> <span class="o">*</span> <span class="n">fn</span><span class="p">(</span><span class="n">frame_data</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">+</span> <span class="n">l_min</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">oetf_pq</span><span class="p">(</span><span class="n">frame_data</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Perceptual quantizer opto-electrical transfer function defined in ITU-R Rec. BT.2100</span>

<span class="sd">        Args:</span>
<span class="sd">            frame_data: pixel values expected to be in the physical luminance between 0 and 10,000 cd/m^2</span>

<span class="sd">        Returns:</span>
<span class="sd">            frame_data: pixel values in the range [0, 1]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">m</span> <span class="o">=</span> <span class="mf">78.84375</span>
        <span class="n">n</span> <span class="o">=</span> <span class="mf">0.1593017578125</span>
        <span class="n">c1</span> <span class="o">=</span> <span class="mf">0.8359375</span>
        <span class="n">c2</span> <span class="o">=</span> <span class="mf">18.8515625</span>
        <span class="n">c3</span> <span class="o">=</span> <span class="mf">18.6875</span>
        <span class="n">lm1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="mf">10000.0</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
        <span class="c1"># FIXME: this might return an error if input is negative, see https://stackoverflow.com/q/45384602/</span>
        <span class="n">lm2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">frame_data</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>

        <span class="n">frame_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">((</span><span class="n">c1</span> <span class="o">*</span> <span class="n">lm1</span> <span class="o">+</span> <span class="n">c2</span> <span class="o">*</span> <span class="n">lm2</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">lm1</span> <span class="o">+</span> <span class="n">c3</span> <span class="o">*</span> <span class="n">lm2</span><span class="p">),</span> <span class="n">m</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">frame_data</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">oetf_pu21</span><span class="p">(</span>
        <span class="n">frame_data</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
        <span class="n">mode</span><span class="p">:</span> <span class="n">Pu21Mode</span> <span class="o">=</span> <span class="n">Pu21Mode</span><span class="o">.</span><span class="n">BANDING</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        PU21 OETF, see https://github.com/gfxdisp/pu21</span>

<span class="sd">        Args:</span>
<span class="sd">            frame_data (np.ndarray): Raw frame data in full range, values in the range [0, 1]</span>
<span class="sd">            mode (Pu21Mode), defaults to Pu21Mode.BANDING</span>

<span class="sd">        Returns:</span>
<span class="sd">            frame_data: pixel values in the range [0, 1]</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;banding&quot;</span><span class="p">:</span>
            <span class="n">p</span> <span class="o">=</span> <span class="p">[</span>
                <span class="mf">1.070275272</span><span class="p">,</span>
                <span class="mf">0.4088273932</span><span class="p">,</span>
                <span class="mf">0.153224308</span><span class="p">,</span>
                <span class="mf">0.2520326168</span><span class="p">,</span>
                <span class="mf">1.063512885</span><span class="p">,</span>
                <span class="mf">1.14115047</span><span class="p">,</span>
                <span class="mf">521.4527484</span><span class="p">,</span>
            <span class="p">]</span>
            <span class="n">p_min</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.5580e-07</span>
            <span class="n">p_max</span> <span class="o">=</span> <span class="mf">520.4673</span>
        <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;banding_glare&quot;</span><span class="p">:</span>
            <span class="n">p</span> <span class="o">=</span> <span class="p">[</span>
                <span class="mf">0.353487901</span><span class="p">,</span>
                <span class="mf">0.3734658629</span><span class="p">,</span>
                <span class="mf">8.277049286e-05</span><span class="p">,</span>
                <span class="mf">0.9062562627</span><span class="p">,</span>
                <span class="mf">0.09150303166</span><span class="p">,</span>
                <span class="mf">0.9099517204</span><span class="p">,</span>
                <span class="mf">596.3148142</span><span class="p">,</span>
            <span class="p">]</span>
            <span class="n">p_min</span> <span class="o">=</span> <span class="mf">5.4705e-10</span>
            <span class="n">p_max</span> <span class="o">=</span> <span class="mf">595.3939</span>
        <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;peaks&quot;</span><span class="p">:</span>
            <span class="n">p</span> <span class="o">=</span> <span class="p">[</span>
                <span class="mf">1.043882782</span><span class="p">,</span>
                <span class="mf">0.6459495343</span><span class="p">,</span>
                <span class="mf">0.3194584211</span><span class="p">,</span>
                <span class="mf">0.374025247</span><span class="p">,</span>
                <span class="mf">1.114783422</span><span class="p">,</span>
                <span class="mf">1.095360363</span><span class="p">,</span>
                <span class="mf">384.9217577</span><span class="p">,</span>
            <span class="p">]</span>
            <span class="n">p_min</span> <span class="o">=</span> <span class="mf">1.3674e-07</span>
            <span class="n">p_max</span> <span class="o">=</span> <span class="mf">380.9853</span>
        <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;peaks_glare&quot;</span><span class="p">:</span>
            <span class="n">p</span> <span class="o">=</span> <span class="p">[</span>
                <span class="mf">816.885024</span><span class="p">,</span>
                <span class="mf">1479.463946</span><span class="p">,</span>
                <span class="mf">0.001253215609</span><span class="p">,</span>
                <span class="mf">0.9329636822</span><span class="p">,</span>
                <span class="mf">0.06746643971</span><span class="p">,</span>
                <span class="mf">1.573435413</span><span class="p">,</span>
                <span class="mf">419.6006374</span><span class="p">,</span>
            <span class="p">]</span>
            <span class="n">p_min</span> <span class="o">=</span> <span class="o">-</span><span class="mf">9.7360e-08</span>
            <span class="n">p_max</span> <span class="o">=</span> <span class="mf">407.5066</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Invalid mode specified for PU21&quot;</span><span class="p">)</span>

        <span class="c1"># scale frame_data to the range 0.005 - 10,000</span>
        <span class="c1"># disabled since the input is already in physical luminance</span>
        <span class="c1"># frame_data = frame_data * 10000.0</span>
        <span class="c1"># frame_data = np.maximum(frame_data, 0.05)</span>

        <span class="n">frame_data</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span>
                <span class="p">(</span>
                    <span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">frame_data</span><span class="p">,</span> <span class="n">p</span><span class="p">[</span><span class="mi">3</span><span class="p">]))</span>
                    <span class="o">/</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="n">p</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">frame_data</span><span class="p">,</span> <span class="n">p</span><span class="p">[</span><span class="mi">3</span><span class="p">]))</span>
                <span class="p">),</span>
                <span class="n">p</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span>
            <span class="p">)</span>
            <span class="o">-</span> <span class="n">p</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>
        <span class="p">)</span>

        <span class="c1"># get the output into the range [0, 1]</span>
        <span class="n">frame_data</span> <span class="o">=</span> <span class="p">(</span><span class="n">frame_data</span> <span class="o">-</span> <span class="n">p_min</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">p_max</span> <span class="o">-</span> <span class="n">p_min</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">frame_data</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">eotf_hlg</span><span class="p">(</span>
        <span class="n">frame_data</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
        <span class="n">l_min</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">DEFAULT_L_MIN_HDR</span><span class="p">,</span>
        <span class="n">l_max</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">DEFAULT_L_MAX_HDR</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Hybrid log-gamma opto-electrical transfer function defined in ITU-T Rec. BT.2100</span>

<span class="sd">        Args:</span>
<span class="sd">            frame_data: pixel values expected to be in the range [0, 1]</span>

<span class="sd">        Returns:</span>
<span class="sd">            frame_data: pixel values in the physical luminance up to 10,000 cd/m^2</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">frame_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">frame_data</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
        <span class="n">frame_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">frame_data</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>

        <span class="n">a</span> <span class="o">=</span> <span class="mf">0.17883277</span>
        <span class="n">b</span> <span class="o">=</span> <span class="mf">0.02372241</span>
        <span class="n">c</span> <span class="o">=</span> <span class="mf">1.00429347</span>
        <span class="n">gamma</span> <span class="o">=</span> <span class="mf">1.2</span>

        <span class="n">frame_data</span> <span class="o">=</span> <span class="p">(</span><span class="n">frame_data</span> <span class="o">&lt;=</span> <span class="mf">0.5</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">frame_data</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">)</span> <span class="o">/</span> <span class="mf">3.0</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span>
            <span class="n">frame_data</span> <span class="o">&gt;</span> <span class="mf">0.5</span>
        <span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">((</span><span class="n">frame_data</span> <span class="o">-</span> <span class="n">c</span><span class="p">)</span> <span class="o">/</span> <span class="n">a</span><span class="p">)</span> <span class="o">-</span> <span class="n">b</span><span class="p">)</span>

        <span class="n">frame_data</span> <span class="o">=</span> <span class="p">(</span><span class="n">l_max</span> <span class="o">-</span> <span class="n">l_min</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">frame_data</span><span class="p">,</span> <span class="n">gamma</span> <span class="o">-</span> <span class="mf">1.0</span><span class="p">)</span> <span class="o">+</span> <span class="n">l_min</span>

        <span class="k">return</span> <span class="n">frame_data</span>

    <span class="k">def</span> <span class="nf">normalize_to_original_range</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frame_data</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="nb">float</span><span class="p">]):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Normalize frame data in the range [0, 1] to their original range, based on</span>
<span class="sd">        bit depth, e.g. from [0, 1] to [0, 255].</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">frame_data</span> <span class="o">*</span> <span class="p">(</span><span class="mi">2</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">bit_depth</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">normalize_to_original_si_range</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frame_data</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="nb">float</span><span class="p">]):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Normalize frame data in the range [0, 1] to [0, 255], which was the original</span>
<span class="sd">        range for SI/TI.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">frame_data</span> <span class="o">*</span> <span class="p">(</span><span class="mi">2</span><span class="o">**</span><span class="mi">8</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">normalize_between_0_1</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frame_data</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="nb">float</span><span class="p">]):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Normalize frame data in the range [0, x] to [0, 1], based on bit depth.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">frame_data</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">bit_depth</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">add_frame_callback</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">callback_fn</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">float</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="kc">None</span><span class="p">],</span> <span class="nb">int</span><span class="p">],</span> <span class="kc">None</span><span class="p">]</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add a function that gets called whenever a frame&#39;s values are available</span>

<span class="sd">        Args:</span>
<span class="sd">            callback_fn (Callable[[float, Union[float, None], int], None]): The function that should get called. It will receive SI, TI and the frame number.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">callbacks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">callback_fn</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">handle_limited_range</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frame_data</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Transforms data from limited range to full range. We expect the input to be in [16/255, 235/255] already.</span>
<span class="sd">        Apply this to limited range content only! If we exceed the limited range, an error will be raised.</span>

<span class="sd">        Args:</span>
<span class="sd">            frame_data (np.ndarray): The frame data in limited range.</span>

<span class="sd">        Returns:</span>
<span class="sd">            frame_data: The frame data in full range between [0, 1].</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">input_min</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">frame_data</span><span class="p">)</span>
        <span class="n">input_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">frame_data</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">input_min</span> <span class="o">+</span> <span class="mf">0.001</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">LIMITED_RANGE_MIN</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span>
            <span class="n">input_max</span> <span class="o">-</span> <span class="mf">0.001</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">LIMITED_RANGE_MAX</span>
        <span class="p">):</span>
            <span class="c1"># inform the user about the original range</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                <span class="s2">&quot;Input appears to be full range, but it is treated as limited range SDR! &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;Input range is [</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">normalize_to_original_range</span><span class="p">(</span><span class="n">input_min</span><span class="p">))</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">normalize_to_original_range</span><span class="p">(</span><span class="n">input_max</span><span class="p">))</span><span class="si">}</span><span class="s2">]. &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;Expected range for limited content [</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">normalize_to_original_range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">LIMITED_RANGE_MIN</span><span class="p">))</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">normalize_to_original_range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">LIMITED_RANGE_MAX</span><span class="p">))</span><span class="si">}</span><span class="s2">]. &quot;</span>
                <span class="s2">&quot;Specify the range as full instead.&quot;</span>
            <span class="p">)</span>
        <span class="c1"># scale up to full range</span>
        <span class="n">frame_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span>
            <span class="p">(</span><span class="n">frame_data</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">LIMITED_RANGE_MIN</span><span class="p">)</span>
            <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">LIMITED_RANGE_MAX</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">LIMITED_RANGE_MIN</span><span class="p">),</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">frame_data</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">plot_histogram</span><span class="p">(</span><span class="n">frame_data</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">plotille</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span>
            <span class="n">frame_data</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">bins</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">78</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span> <span class="n">x_min</span><span class="o">=</span><span class="mi">0</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">calculate</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">input_file</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">num_frames</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span> <span class="n">List</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="kc">None</span><span class="p">]],</span> <span class="nb">int</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Calculate SI and TI from an input file.</span>

<span class="sd">        Returns two arrays and one integer, the first array being the SI values, the</span>
<span class="sd">        second array being the TI values. The first element of the TI value array will</span>
<span class="sd">        always be 0. The integer will be equal to the number of frames read.</span>

<span class="sd">        You can also get the results later via .get_results()</span>

<span class="sd">        Args:</span>
<span class="sd">            input_file (str): input file path</span>
<span class="sd">            num_frames (int): number of frames to calculate. Defaults to 0 (unlimited).</span>

<span class="sd">        Returns:</span>
<span class="sd">            [[float], [float|None], int]: [si_values], [ti_values], frame count</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">si_values</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ti_values</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">last_input_file</span> <span class="o">=</span> <span class="n">input_file</span>
        <span class="n">previous_frame_data</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">current_frame</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">frame_data</span> <span class="ow">in</span> <span class="n">read_container</span><span class="p">(</span><span class="n">input_file</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="ow">and</span> <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Frame </span><span class="si">{</span><span class="n">current_frame</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">current_frame</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Original frame data&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_log_frame_data</span><span class="p">(</span><span class="n">frame_data</span><span class="p">)</span>

            <span class="c1"># Normalize frame data according to bit depth between 0 and 1.</span>
            <span class="c1"># This will transform [0, 255] to [0, 1], and [0, 1023] to [0, 1] etc.</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">legacy</span><span class="p">:</span>
                <span class="n">frame_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">normalize_between_0_1</span><span class="p">(</span><span class="n">frame_data</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">current_frame</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Frame data after normalization between 0 and 1&quot;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_log_frame_data</span><span class="p">(</span><span class="n">frame_data</span><span class="p">)</span>

                <span class="c1"># convert limited to full range</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">color_range</span> <span class="o">==</span> <span class="n">ColorRange</span><span class="o">.</span><span class="n">LIMITED</span><span class="p">:</span>
                    <span class="n">frame_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">handle_limited_range</span><span class="p">(</span><span class="n">frame_data</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">current_frame</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Frame data after limited-range normalization&quot;</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_log_frame_data</span><span class="p">(</span><span class="n">frame_data</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># in full range, we do not have to further process the data</span>
                    <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">color_range</span> <span class="o">==</span> <span class="n">ColorRange</span><span class="o">.</span><span class="n">LIMITED</span><span class="p">:</span>
                    <span class="c1"># legacy mode, apply the old way of normalizing data between 16-235</span>
                    <span class="n">input_min</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">frame_data</span><span class="p">)</span>
                    <span class="n">input_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">frame_data</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">input_min</span> <span class="o">&lt;</span> <span class="mi">16</span> <span class="ow">or</span> <span class="n">input_max</span> <span class="o">&gt;</span> <span class="mi">235</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;Input appears to be full range ([</span><span class="si">{</span><span class="n">input_min</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">input_max</span><span class="si">}</span><span class="s2">]), specify --color-range=full!&quot;</span>
                        <span class="p">)</span>
                    <span class="c1"># convert to grey by assumng limited range input</span>
                    <span class="n">frame_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">((</span><span class="n">frame_data</span> <span class="o">-</span> <span class="mi">16</span><span class="p">)</span> <span class="o">/</span> <span class="p">((</span><span class="mi">235</span> <span class="o">-</span> <span class="mi">16</span><span class="p">)</span> <span class="o">/</span> <span class="mi">255</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># in full range, we do not have to further process the data</span>
                    <span class="k">pass</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">legacy</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hdr_mode</span> <span class="o">==</span> <span class="n">HdrMode</span><span class="o">.</span><span class="n">SDR</span><span class="p">:</span>
                    <span class="n">frame_data</span> <span class="o">=</span> <span class="n">SiTiCalculator</span><span class="o">.</span><span class="n">apply_display_model</span><span class="p">(</span>
                        <span class="n">frame_data</span><span class="p">,</span>
                        <span class="n">eotf_function</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">eotf_function</span><span class="p">,</span>
                        <span class="n">l_max</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">l_max</span><span class="p">,</span>
                        <span class="n">l_min</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">l_min</span><span class="p">,</span>
                        <span class="n">gamma</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gamma</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="k">if</span> <span class="n">current_frame</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;Frame data after apply_display_model for SDR (</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">l_min</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">l_max</span><span class="si">}</span><span class="s2">)&quot;</span>
                        <span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_log_frame_data</span><span class="p">(</span><span class="n">frame_data</span><span class="p">)</span>
                    <span class="n">frame_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">oetf_function</span><span class="p">(</span>
                        <span class="n">frame_data</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">oetf_function_kwargs</span>
                    <span class="p">)</span>
                    <span class="k">if</span> <span class="n">current_frame</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;Frame data after OETF function </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">oetf_function</span><span class="si">}</span><span class="s2"> with args </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">oetf_function_kwargs</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_log_frame_data</span><span class="p">(</span><span class="n">frame_data</span><span class="p">)</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">hdr_mode</span> <span class="o">==</span> <span class="n">HdrMode</span><span class="o">.</span><span class="n">HDR10</span><span class="p">:</span>
                    <span class="c1"># nothing to do, we are already in PQ domain</span>
                    <span class="c1"># TODO allow using Pu21 here?</span>
                    <span class="k">pass</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">hdr_mode</span> <span class="o">==</span> <span class="n">HdrMode</span><span class="o">.</span><span class="n">HLG</span><span class="p">:</span>
                    <span class="n">frame_data</span> <span class="o">=</span> <span class="n">SiTiCalculator</span><span class="o">.</span><span class="n">eotf_hlg</span><span class="p">(</span>
                        <span class="n">frame_data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">l_min</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">l_max</span>
                    <span class="p">)</span>
                    <span class="k">if</span> <span class="n">current_frame</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;Frame data after eotf_hlg for HLG with l_min/l_max settings </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">l_min</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">l_max</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_log_frame_data</span><span class="p">(</span><span class="n">frame_data</span><span class="p">)</span>
                    <span class="n">frame_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">oetf_function</span><span class="p">(</span>
                        <span class="n">frame_data</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">oetf_function_kwargs</span>
                    <span class="p">)</span>
                    <span class="k">if</span> <span class="n">current_frame</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;Frame data after OETF function </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">oetf_function</span><span class="si">}</span><span class="s2"> with args </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">oetf_function_kwargs</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_log_frame_data</span><span class="p">(</span><span class="n">frame_data</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid HDR mode &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">hdr_mode</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">legacy</span><span class="p">:</span>
                <span class="n">si_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">normalize_to_original_si_range</span><span class="p">(</span>
                    <span class="n">SiTiCalculator</span><span class="o">.</span><span class="n">si</span><span class="p">(</span><span class="n">frame_data</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">si_value</span> <span class="o">=</span> <span class="n">SiTiCalculator</span><span class="o">.</span><span class="n">si</span><span class="p">(</span><span class="n">frame_data</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">current_frame</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">legacy</span><span class="p">:</span>
                    <span class="n">ti_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">normalize_to_original_si_range</span><span class="p">(</span>
                        <span class="n">cast</span><span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="n">SiTiCalculator</span><span class="o">.</span><span class="n">ti</span><span class="p">(</span><span class="n">frame_data</span><span class="p">,</span> <span class="n">previous_frame_data</span><span class="p">))</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">ti_value</span> <span class="o">=</span> <span class="n">SiTiCalculator</span><span class="o">.</span><span class="n">ti</span><span class="p">(</span><span class="n">frame_data</span><span class="p">,</span> <span class="n">previous_frame_data</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ti_value</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;SI value </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="n">SiTiCalculator</span><span class="o">.</span><span class="n">si</span><span class="p">(</span><span class="n">frame_data</span><span class="p">),</span> <span class="mi">3</span><span class="p">)</span><span class="si">}</span><span class="s2">, normalized: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">normalize_to_original_si_range</span><span class="p">(</span><span class="n">SiTiCalculator</span><span class="o">.</span><span class="n">si</span><span class="p">(</span><span class="n">frame_data</span><span class="p">)),</span> <span class="mi">3</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">ti_value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;TI value </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="n">cast</span><span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="n">SiTiCalculator</span><span class="o">.</span><span class="n">ti</span><span class="p">(</span><span class="n">frame_data</span><span class="p">,</span> <span class="n">previous_frame_data</span><span class="p">)),</span> <span class="mi">3</span><span class="p">)</span><span class="si">}</span><span class="s2">, normalized: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">normalize_to_original_si_range</span><span class="p">(</span><span class="n">cast</span><span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="n">SiTiCalculator</span><span class="o">.</span><span class="n">ti</span><span class="p">(</span><span class="n">frame_data</span><span class="p">,</span> <span class="n">previous_frame_data</span><span class="p">))),</span> <span class="mi">3</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">si_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cast</span><span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="n">si_value</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">ti_value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ti_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cast</span><span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="n">ti_value</span><span class="p">))</span>

            <span class="n">previous_frame_data</span> <span class="o">=</span> <span class="n">frame_data</span>

            <span class="n">current_frame</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="k">for</span> <span class="n">callback</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">callbacks</span><span class="p">:</span>
                <span class="n">callback</span><span class="p">(</span><span class="n">si_value</span><span class="p">,</span> <span class="n">ti_value</span><span class="p">,</span> <span class="n">current_frame</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">num_frames</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="ow">and</span> <span class="n">current_frame</span> <span class="o">&gt;=</span> <span class="n">num_frames</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">si_values</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ti_values</span><span class="p">,</span> <span class="n">current_frame</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">si_values</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ti_values</span><span class="p">,</span> <span class="n">current_frame</span>

    <span class="k">def</span> <span class="nf">get_csv_results</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a CSV string with the results.</span>

<span class="sd">        Note that this does not output all data. Also, the first TI value will be output as &quot;None&quot;.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># prepend a zero here</span>
        <span class="n">ti_values_to_output</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">ti_values</span><span class="p">]</span>

        <span class="n">output</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">StringIO</span><span class="p">()</span>
        <span class="n">writer</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">DictWriter</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="n">fieldnames</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;input_file&quot;</span><span class="p">,</span> <span class="s2">&quot;n&quot;</span><span class="p">,</span> <span class="s2">&quot;si&quot;</span><span class="p">,</span> <span class="s2">&quot;ti&quot;</span><span class="p">])</span>
        <span class="n">writer</span><span class="o">.</span><span class="n">writeheader</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="p">(</span><span class="n">si_value</span><span class="p">,</span> <span class="n">ti_value</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span>
            <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">si_values</span><span class="p">,</span> <span class="n">ti_values_to_output</span><span class="p">)</span>
        <span class="p">):</span>
            <span class="n">writer</span><span class="o">.</span><span class="n">writerow</span><span class="p">(</span>
                <span class="p">{</span>
                    <span class="s2">&quot;input_file&quot;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">last_input_file</span><span class="p">)</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_input_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                    <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;n&quot;</span><span class="p">:</span> <span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
                    <span class="s2">&quot;si&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">si_value</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>
                    <span class="s2">&quot;ti&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">ti_value</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="k">if</span> <span class="n">ti_value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
                <span class="p">}</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">output</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">get_results</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get a JSON-serializable result dictionary with SI, TI values, as well as used settings.</span>

<span class="sd">        Returns:</span>
<span class="sd">            dict: A dictionary containing &quot;si&quot;, &quot;ti&quot; arrays, &quot;settings&quot; as a dict, and the &quot;input_file&quot; name.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;si&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">si_values</span><span class="p">,</span>
            <span class="s2">&quot;ti&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">ti_values</span><span class="p">,</span>
            <span class="s2">&quot;settings&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_general_settings</span><span class="p">(),</span>
            <span class="s2">&quot;input_file&quot;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">last_input_file</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_input_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">_log_frame_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frame_data</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;  [</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">frame_data</span><span class="p">),</span> <span class="mi">3</span><span class="p">)</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">frame_data</span><span class="p">),</span> <span class="mi">3</span><span class="p">)</span><span class="si">}</span><span class="s2">], mean </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">frame_data</span><span class="p">),</span> <span class="mi">3</span><span class="p">)</span><span class="si">}</span><span class="s2">, median </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">frame_data</span><span class="p">),</span> <span class="mi">3</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_histogram</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">SiTiCalculator</span><span class="o">.</span><span class="n">plot_histogram</span><span class="p">(</span><span class="n">frame_data</span><span class="p">))</span>
</pre></div>

        </details>

    

                            <div id="SiTiCalculator.__init__" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#SiTiCalculator.__init__">#&nbsp;&nbsp</a>

        
            <span class="name">SiTiCalculator</span><span class="signature">(
    self,
    hdr_mode: <a href="#HdrMode">siti_tools.siti.HdrMode</a> = &lt;<a href="#HdrMode.SDR">HdrMode.SDR</a>: &#39;sdr&#39;&gt;,
    bit_depth: int = 8,
    color_range: <a href="#ColorRange">siti_tools.siti.ColorRange</a> = &lt;<a href="#ColorRange.LIMITED">ColorRange.LIMITED</a>: &#39;limited&#39;&gt;,
    eotf_function: <a href="#EotfFunction">siti_tools.siti.EotfFunction</a> = &lt;<a href="#EotfFunction.BT1886">EotfFunction.BT1886</a>: &#39;bt1886&#39;&gt;,
    calculation_domain: <a href="#CalculationDomain">siti_tools.siti.CalculationDomain</a> = &lt;<a href="#CalculationDomain.PQ">CalculationDomain.PQ</a>: &#39;pq&#39;&gt;,
    l_max: Optional[float] = None,
    l_min: Optional[float] = None,
    gamma: float = 2.4,
    pu21_mode: <a href="#Pu21Mode">siti_tools.siti.Pu21Mode</a> = &lt;<a href="#Pu21Mode.BANDING">Pu21Mode.BANDING</a>: &#39;banding&#39;&gt;,
    verbose=False,
    show_histogram=False,
    legacy=False
)</span>    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">hdr_mode</span><span class="p">:</span> <span class="n">HdrMode</span> <span class="o">=</span> <span class="n">DEFAULT_HDR_MODE</span><span class="p">,</span>
        <span class="n">bit_depth</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">DEFAULT_BIT_DEPTH</span><span class="p">,</span>
        <span class="n">color_range</span><span class="p">:</span> <span class="n">ColorRange</span> <span class="o">=</span> <span class="n">DEFAULT_COLOR_RANGE</span><span class="p">,</span>
        <span class="n">eotf_function</span><span class="p">:</span> <span class="n">EotfFunction</span> <span class="o">=</span> <span class="n">DEFAULT_EOTF_FUNCTION</span><span class="p">,</span>
        <span class="n">calculation_domain</span><span class="p">:</span> <span class="n">CalculationDomain</span> <span class="o">=</span> <span class="n">DEFAULT_CALCULATION_DOMAIN</span><span class="p">,</span>
        <span class="n">l_max</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">l_min</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">gamma</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">DEFAULT_GAMMA</span><span class="p">,</span>
        <span class="n">pu21_mode</span><span class="p">:</span> <span class="n">Pu21Mode</span> <span class="o">=</span> <span class="n">DEFAULT_PU21_MODE</span><span class="p">,</span>
        <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">show_histogram</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">legacy</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a new SI/TI calculator</span>

<span class="sd">        Args:</span>
<span class="sd">            hdr_mode (HdrMode, optional): Select SDR, HDR10 or HLG. Defaults to SDR.</span>
<span class="sd">            bit_depth (int, optional): 8, 10 or 12. Defaults to 8.</span>
<span class="sd">            color_range (ColorRange, optional): Set the color range (limited or full). Defaults to limited.</span>
<span class="sd">            eotf_function (EotfFunction, optional): EOTF function for converting SDR to HDR. Defaults to BT.1886.</span>
<span class="sd">            calculation_domain (CalculationDomain, optional): Domain to calculate SI/TI in. Defaults to PQ.</span>
<span class="sd">            l_max (float, optional): Set the peak display luminance in cd/m2. Defaults to 300 (SDR) or 1000 (HDR).</span>
<span class="sd">            l_min (float, optional): Set the black display luminance in cd/m2. Defaults to 0.1 (SDR) or 0.01 (HDR).</span>
<span class="sd">            gamma (float, optional): Set the BT.1886 gamma. Defaults to 2.4.</span>
<span class="sd">            pu21_mode (Pu21Mode, optional): Set the default PU21 mode. Defaults to BANDING.</span>
<span class="sd">            verbose (bool, optional): Show verbose logging for the first frame.</span>
<span class="sd">            show_histogram (bool, optional): Show a histogram for the first frame (computation-intensive, implies verbose=True).</span>
<span class="sd">            legacy (bool, optional): Use legacy SI/TI calculation. Defaults to False.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">show_histogram</span> <span class="o">=</span> <span class="n">show_histogram</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">legacy</span> <span class="o">=</span> <span class="n">legacy</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_histogram</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">callbacks</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Callable</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">hdr_mode</span> <span class="o">=</span> <span class="n">hdr_mode</span>

        <span class="k">if</span> <span class="n">bit_depth</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">8</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">12</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Bit depth must be one of 8, 10, 12&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">bit_depth</span> <span class="o">=</span> <span class="n">bit_depth</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">color_range</span> <span class="o">=</span> <span class="n">color_range</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">eotf_function</span> <span class="o">=</span> <span class="n">eotf_function</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">calculation_domain</span> <span class="o">=</span> <span class="n">calculation_domain</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">pu21_mode</span> <span class="o">=</span> <span class="n">pu21_mode</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">oetf_function_kwargs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculation_domain</span> <span class="o">==</span> <span class="n">CalculationDomain</span><span class="o">.</span><span class="n">PQ</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">oetf_function</span> <span class="o">=</span> <span class="n">SiTiCalculator</span><span class="o">.</span><span class="n">oetf_pq</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">oetf_function</span> <span class="o">=</span> <span class="n">SiTiCalculator</span><span class="o">.</span><span class="n">oetf_pu21</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">oetf_function_kwargs</span><span class="p">[</span><span class="s2">&quot;mode&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pu21_mode</span>

        <span class="c1"># overwrite the default depending on HDR type</span>
        <span class="k">if</span> <span class="n">l_max</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">l_max</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">SiTiCalculator</span><span class="o">.</span><span class="n">DEFAULT_L_MAX</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hdr_mode</span> <span class="o">==</span> <span class="n">HdrMode</span><span class="o">.</span><span class="n">SDR</span>
                <span class="k">else</span> <span class="n">SiTiCalculator</span><span class="o">.</span><span class="n">DEFAULT_L_MAX_HDR</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">l_max</span> <span class="o">=</span> <span class="n">l_max</span>
        <span class="k">if</span> <span class="n">l_min</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">l_min</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">SiTiCalculator</span><span class="o">.</span><span class="n">DEFAULT_L_MIN</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hdr_mode</span> <span class="o">==</span> <span class="n">HdrMode</span><span class="o">.</span><span class="n">SDR</span>
                <span class="k">else</span> <span class="n">SiTiCalculator</span><span class="o">.</span><span class="n">DEFAULT_L_MIN_HDR</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">l_min</span> <span class="o">=</span> <span class="n">l_min</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">gamma</span> <span class="o">=</span> <span class="n">gamma</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">si_values</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ti_values</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="kc">None</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">last_input_file</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</pre></div>

        </details>

            <div class="docstring"><p>Create a new SI/TI calculator</p>

<h6 id="args">Args</h6>

<ul>
<li><strong>hdr_mode (HdrMode, optional):</strong>  Select SDR, HDR10 or HLG. Defaults to SDR.</li>
<li><strong>bit_depth (int, optional):</strong>  8, 10 or 12. Defaults to 8.</li>
<li><strong>color_range (ColorRange, optional):</strong>  Set the color range (limited or full). Defaults to limited.</li>
<li><strong>eotf_function (EotfFunction, optional):</strong>  EOTF function for converting SDR to HDR. Defaults to BT.1886.</li>
<li><strong>calculation_domain (CalculationDomain, optional):</strong>  Domain to calculate SI/TI in. Defaults to PQ.</li>
<li><strong>l_max (float, optional):</strong>  Set the peak display luminance in cd/m2. Defaults to 300 (SDR) or 1000 (HDR).</li>
<li><strong>l_min (float, optional):</strong>  Set the black display luminance in cd/m2. Defaults to 0.1 (SDR) or 0.01 (HDR).</li>
<li><strong>gamma (float, optional):</strong>  Set the BT.1886 gamma. Defaults to 2.4.</li>
<li><strong>pu21_mode (Pu21Mode, optional):</strong>  Set the default PU21 mode. Defaults to BANDING.</li>
<li><strong>verbose (bool, optional):</strong>  Show verbose logging for the first frame.</li>
<li><strong>show_histogram (bool, optional):</strong>  Show a histogram for the first frame (computation-intensive, implies verbose=True).</li>
<li><strong>legacy (bool, optional):</strong>  Use legacy SI/TI calculation. Defaults to False.</li>
</ul>
</div>


                            </div>
                            <div id="SiTiCalculator.DEFAULT_HDR_MODE" class="classattr">
                                            <div class="attr variable"><a class="headerlink" href="#SiTiCalculator.DEFAULT_HDR_MODE">#&nbsp;&nbsp</a>

        <span class="name">DEFAULT_HDR_MODE</span><span class="default_value"> = &lt;<a href="#HdrMode.SDR">HdrMode.SDR</a>: &#39;sdr&#39;&gt;</span>
    </div>

    

                            </div>
                            <div id="SiTiCalculator.DEFAULT_BIT_DEPTH" class="classattr">
                                            <div class="attr variable"><a class="headerlink" href="#SiTiCalculator.DEFAULT_BIT_DEPTH">#&nbsp;&nbsp</a>

        <span class="name">DEFAULT_BIT_DEPTH</span><span class="default_value"> = 8</span>
    </div>

    

                            </div>
                            <div id="SiTiCalculator.DEFAULT_COLOR_RANGE" class="classattr">
                                            <div class="attr variable"><a class="headerlink" href="#SiTiCalculator.DEFAULT_COLOR_RANGE">#&nbsp;&nbsp</a>

        <span class="name">DEFAULT_COLOR_RANGE</span><span class="default_value"> = &lt;<a href="#ColorRange.LIMITED">ColorRange.LIMITED</a>: &#39;limited&#39;&gt;</span>
    </div>

    

                            </div>
                            <div id="SiTiCalculator.DEFAULT_EOTF_FUNCTION" class="classattr">
                                            <div class="attr variable"><a class="headerlink" href="#SiTiCalculator.DEFAULT_EOTF_FUNCTION">#&nbsp;&nbsp</a>

        <span class="name">DEFAULT_EOTF_FUNCTION</span><span class="default_value"> = &lt;<a href="#EotfFunction.BT1886">EotfFunction.BT1886</a>: &#39;bt1886&#39;&gt;</span>
    </div>

    

                            </div>
                            <div id="SiTiCalculator.DEFAULT_CALCULATION_DOMAIN" class="classattr">
                                            <div class="attr variable"><a class="headerlink" href="#SiTiCalculator.DEFAULT_CALCULATION_DOMAIN">#&nbsp;&nbsp</a>

        <span class="name">DEFAULT_CALCULATION_DOMAIN</span><span class="default_value"> = &lt;<a href="#CalculationDomain.PQ">CalculationDomain.PQ</a>: &#39;pq&#39;&gt;</span>
    </div>

    

                            </div>
                            <div id="SiTiCalculator.DEFAULT_PU21_MODE" class="classattr">
                                            <div class="attr variable"><a class="headerlink" href="#SiTiCalculator.DEFAULT_PU21_MODE">#&nbsp;&nbsp</a>

        <span class="name">DEFAULT_PU21_MODE</span><span class="default_value"> = &lt;<a href="#Pu21Mode.BANDING">Pu21Mode.BANDING</a>: &#39;banding&#39;&gt;</span>
    </div>

    

                            </div>
                            <div id="SiTiCalculator.DEFAULT_GAMMA" class="classattr">
                                            <div class="attr variable"><a class="headerlink" href="#SiTiCalculator.DEFAULT_GAMMA">#&nbsp;&nbsp</a>

        <span class="name">DEFAULT_GAMMA</span><span class="default_value"> = 2.4</span>
    </div>

    

                            </div>
                            <div id="SiTiCalculator.DEFAULT_L_MIN" class="classattr">
                                            <div class="attr variable"><a class="headerlink" href="#SiTiCalculator.DEFAULT_L_MIN">#&nbsp;&nbsp</a>

        <span class="name">DEFAULT_L_MIN</span><span class="default_value"> = 0.1</span>
    </div>

    

                            </div>
                            <div id="SiTiCalculator.DEFAULT_L_MAX" class="classattr">
                                            <div class="attr variable"><a class="headerlink" href="#SiTiCalculator.DEFAULT_L_MAX">#&nbsp;&nbsp</a>

        <span class="name">DEFAULT_L_MAX</span><span class="default_value"> = 300</span>
    </div>

    

                            </div>
                            <div id="SiTiCalculator.DEFAULT_L_MIN_HDR" class="classattr">
                                            <div class="attr variable"><a class="headerlink" href="#SiTiCalculator.DEFAULT_L_MIN_HDR">#&nbsp;&nbsp</a>

        <span class="name">DEFAULT_L_MIN_HDR</span><span class="default_value"> = 0.01</span>
    </div>

    

                            </div>
                            <div id="SiTiCalculator.DEFAULT_L_MAX_HDR" class="classattr">
                                            <div class="attr variable"><a class="headerlink" href="#SiTiCalculator.DEFAULT_L_MAX_HDR">#&nbsp;&nbsp</a>

        <span class="name">DEFAULT_L_MAX_HDR</span><span class="default_value"> = 1000.0</span>
    </div>

    

                            </div>
                            <div id="SiTiCalculator.LIMITED_RANGE_MIN" class="classattr">
                                            <div class="attr variable"><a class="headerlink" href="#SiTiCalculator.LIMITED_RANGE_MIN">#&nbsp;&nbsp</a>

        <span class="name">LIMITED_RANGE_MIN</span><span class="default_value"> = 0.06274509803921569</span>
    </div>

    

                            </div>
                            <div id="SiTiCalculator.LIMITED_RANGE_MAX" class="classattr">
                                            <div class="attr variable"><a class="headerlink" href="#SiTiCalculator.LIMITED_RANGE_MAX">#&nbsp;&nbsp</a>

        <span class="name">LIMITED_RANGE_MAX</span><span class="default_value"> = 0.9215686274509803</span>
    </div>

    

                            </div>
                            <div id="SiTiCalculator.from_settings" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#SiTiCalculator.from_settings">#&nbsp;&nbsp</a>

                <div class="decorator">@staticmethod</div>

            <span class="def">def</span>
            <span class="name">from_settings</span><span class="signature">(settings: Dict)</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">from_settings</span><span class="p">(</span><span class="n">settings</span><span class="p">:</span> <span class="n">Dict</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">SiTiCalculator</span><span class="p">(</span><span class="o">**</span><span class="n">settings</span><span class="p">)</span>
</pre></div>

        </details>

    

                            </div>
                            <div id="SiTiCalculator.callbacks" class="classattr">
                                            <div class="attr variable"><a class="headerlink" href="#SiTiCalculator.callbacks">#&nbsp;&nbsp</a>

        <span class="name">callbacks</span><span class="annotation">: List[Callable]</span>
    </div>

    

                            </div>
                            <div id="SiTiCalculator.si_values" class="classattr">
                                            <div class="attr variable"><a class="headerlink" href="#SiTiCalculator.si_values">#&nbsp;&nbsp</a>

        <span class="name">si_values</span><span class="annotation">: List[float]</span>
    </div>

    

                            </div>
                            <div id="SiTiCalculator.ti_values" class="classattr">
                                            <div class="attr variable"><a class="headerlink" href="#SiTiCalculator.ti_values">#&nbsp;&nbsp</a>

        <span class="name">ti_values</span><span class="annotation">: List[Optional[float]]</span>
    </div>

    

                            </div>
                            <div id="SiTiCalculator.last_input_file" class="classattr">
                                            <div class="attr variable"><a class="headerlink" href="#SiTiCalculator.last_input_file">#&nbsp;&nbsp</a>

        <span class="name">last_input_file</span><span class="annotation">: Optional[str]</span>
    </div>

    

                            </div>
                            <div id="SiTiCalculator.get_general_settings" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#SiTiCalculator.get_general_settings">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">get_general_settings</span><span class="signature">(self) -&gt; Dict</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">get_general_settings</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        A dictionary of settings used for the calculation</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;calculation_domain&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">calculation_domain</span><span class="p">),</span>
            <span class="s2">&quot;hdr_mode&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hdr_mode</span><span class="p">),</span>
            <span class="s2">&quot;bit_depth&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">bit_depth</span><span class="p">,</span>
            <span class="s2">&quot;color_range&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">color_range</span><span class="p">),</span>
            <span class="s2">&quot;eotf_function&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">eotf_function</span><span class="p">),</span>
            <span class="s2">&quot;l_max&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">l_max</span><span class="p">,</span>
            <span class="s2">&quot;l_min&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">l_min</span><span class="p">,</span>
            <span class="s2">&quot;gamma&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">gamma</span><span class="p">,</span>
            <span class="s2">&quot;pu21_mode&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pu21_mode</span><span class="p">),</span>
            <span class="s2">&quot;legacy&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">legacy</span><span class="p">,</span>
            <span class="s2">&quot;version&quot;</span><span class="p">:</span> <span class="n">version</span><span class="p">,</span>
        <span class="p">}</span>
</pre></div>

        </details>

            <div class="docstring"><p>A dictionary of settings used for the calculation</p>
</div>


                            </div>
                            <div id="SiTiCalculator.si" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#SiTiCalculator.si">#&nbsp;&nbsp</a>

                <div class="decorator">@staticmethod</div>

            <span class="def">def</span>
            <span class="name">si</span><span class="signature">(frame_data: numpy.ndarray) -&gt; float</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">si</span><span class="p">(</span><span class="n">frame_data</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Calculate SI of a frame</span>

<span class="sd">        Args:</span>
<span class="sd">            frame_data (ndarray): 2D array of input frame data</span>

<span class="sd">        Returns:</span>
<span class="sd">            float: SI</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># TODO: check array dimensions</span>

        <span class="c1"># calculate horizontal/vertical operators</span>
        <span class="n">sob_x</span> <span class="o">=</span> <span class="n">ndimage</span><span class="o">.</span><span class="n">sobel</span><span class="p">(</span><span class="n">frame_data</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">sob_y</span> <span class="o">=</span> <span class="n">ndimage</span><span class="o">.</span><span class="n">sobel</span><span class="p">(</span><span class="n">frame_data</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># crop output to valid window, calculate gradient magnitude</span>
        <span class="n">si</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hypot</span><span class="p">(</span><span class="n">sob_x</span><span class="p">,</span> <span class="n">sob_y</span><span class="p">)[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">si</span>
</pre></div>

        </details>

            <div class="docstring"><p>Calculate SI of a frame</p>

<h6 id="args">Args</h6>

<ul>
<li><strong>frame_data (ndarray):</strong>  2D array of input frame data</li>
</ul>

<h6 id="returns">Returns</h6>

<blockquote>
  <p>float: SI</p>
</blockquote>
</div>


                            </div>
                            <div id="SiTiCalculator.ti" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#SiTiCalculator.ti">#&nbsp;&nbsp</a>

                <div class="decorator">@staticmethod</div>

            <span class="def">def</span>
            <span class="name">ti</span><span class="signature">(
    frame_data: numpy.ndarray,
    previous_frame_data: Optional[numpy.ndarray]
) -&gt; Optional[float]</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">ti</span><span class="p">(</span>
        <span class="n">frame_data</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">previous_frame_data</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate TI between two frames.</span>

<span class="sd">        Args:</span>
<span class="sd">            frame_data (ndarray): 2D array of current frame data</span>
<span class="sd">            previous_frame_data (ndarray): 2D array of previous frame data, must be of same size as current frame</span>

<span class="sd">        Returns:</span>
<span class="sd">            float: TI, or None if previous frame data is not given</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># TODO: check array dimensions</span>
        <span class="c1"># TODO: check array dimensions equal between both args</span>

        <span class="k">if</span> <span class="n">previous_frame_data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">cast</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">frame_data</span> <span class="o">-</span> <span class="n">previous_frame_data</span><span class="p">)</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
</pre></div>

        </details>

            <div class="docstring"><p>Calculate TI between two frames.</p>

<h6 id="args">Args</h6>

<ul>
<li><strong>frame_data (ndarray):</strong>  2D array of current frame data</li>
<li><strong>previous_frame_data (ndarray):</strong>  2D array of previous frame data, must be of same size as current frame</li>
</ul>

<h6 id="returns">Returns</h6>

<blockquote>
  <p>float: TI, or None if previous frame data is not given</p>
</blockquote>
</div>


                            </div>
                            <div id="SiTiCalculator.eotf_1886" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#SiTiCalculator.eotf_1886">#&nbsp;&nbsp</a>

                <div class="decorator">@staticmethod</div>

            <span class="def">def</span>
            <span class="name">eotf_1886</span><span class="signature">(
    frame_data: numpy.ndarray,
    gamma: float = 2.4,
    l_min: float = 0.0,
    l_max: float = 1.0
) -&gt; numpy.ndarray</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">eotf_1886</span><span class="p">(</span>
        <span class="n">frame_data</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
        <span class="n">gamma</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">DEFAULT_GAMMA</span><span class="p">,</span>
        <span class="n">l_min</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span>
        <span class="n">l_max</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Electro-optical transfer function defined in ITU-R Rec. BT.1886</span>

<span class="sd">        Args:</span>
<span class="sd">            frame_data: pixel values expected in the range [0, 1]</span>
<span class="sd">            gamma: exponent</span>
<span class="sd">            l_min: minimum luminance</span>
<span class="sd">            l_max: maximum luminance</span>
<span class="sd">        Note:</span>
<span class="sd">            As the mapping to display luminance happens outside of this function, l_min and l_max are set to 0.0 and 1.0,</span>
<span class="sd">            respectively. If you change these values while using this function in the context of SI/TI calculation, your</span>
<span class="sd">            output will be wrong. You can however change the values when using this function in a standalone fashion.</span>

<span class="sd">        Returns:</span>
<span class="sd">            frame_data: pixel values in the range [0, 1]</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">frame_data</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Input for eotf_1886() was &lt; 0, truncating&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">frame_data</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Input for eotf_1886() was &gt; 1, truncating&quot;</span><span class="p">)</span>

        <span class="n">frame_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">frame_data</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
        <span class="n">frame_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">frame_data</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>

        <span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">l_max</span><span class="p">,</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">gamma</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">l_min</span><span class="p">,</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">gamma</span><span class="p">),</span> <span class="n">gamma</span><span class="p">)</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">l_min</span><span class="p">,</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">gamma</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">l_max</span><span class="p">,</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">gamma</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">l_min</span><span class="p">,</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">gamma</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="n">frame_data</span> <span class="o">=</span> <span class="n">a</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">frame_data</span> <span class="o">+</span> <span class="n">b</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">gamma</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">frame_data</span>
</pre></div>

        </details>

            <div class="docstring"><p>Electro-optical transfer function defined in ITU-R Rec. BT.1886</p>

<h6 id="args">Args</h6>

<ul>
<li><strong>frame_data:</strong>  pixel values expected in the range [0, 1]</li>
<li><strong>gamma:</strong>  exponent</li>
<li><strong>l_min:</strong>  minimum luminance</li>
<li><strong>l_max:</strong>  maximum luminance</li>
</ul>

<h6 id="note">Note</h6>

<blockquote>
  <p>As the mapping to display luminance happens outside of this function, l_min and l_max are set to 0.0 and 1.0,
  respectively. If you change these values while using this function in the context of SI/TI calculation, your
  output will be wrong. You can however change the values when using this function in a standalone fashion.</p>
</blockquote>

<h6 id="returns">Returns</h6>

<blockquote>
  <p>frame_data: pixel values in the range [0, 1]</p>
</blockquote>
</div>


                            </div>
                            <div id="SiTiCalculator.eotf_inv_srgb" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#SiTiCalculator.eotf_inv_srgb">#&nbsp;&nbsp</a>

                <div class="decorator">@staticmethod</div>

            <span class="def">def</span>
            <span class="name">eotf_inv_srgb</span><span class="signature">(frame_data: numpy.ndarray) -&gt; numpy.ndarray</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">eotf_inv_srgb</span><span class="p">(</span><span class="n">frame_data</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Inverse sRGB electro-optical transfer function</span>

<span class="sd">        Args:</span>
<span class="sd">            frame_data: pixel values expected in the range [0, 1]</span>

<span class="sd">        Returns:</span>
<span class="sd">            frame_data: pixel values in the range [0, 1]</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">frame_data</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Input for eotf_inv_srgb() was &lt; 0, truncating&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">frame_data</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Input for eotf_inv_srgb() was &gt; 1, truncating&quot;</span><span class="p">)</span>

        <span class="n">frame_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">frame_data</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
        <span class="n">frame_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">frame_data</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>

        <span class="n">frame_data</span> <span class="o">=</span> <span class="p">(</span><span class="n">frame_data</span> <span class="o">&lt;=</span> <span class="mf">0.04045</span><span class="p">)</span> <span class="o">*</span> <span class="n">frame_data</span> <span class="o">/</span> <span class="mf">12.92</span> <span class="o">+</span> <span class="p">(</span>
            <span class="n">frame_data</span> <span class="o">&gt;</span> <span class="mf">0.04045</span>
        <span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">((</span><span class="n">frame_data</span> <span class="o">+</span> <span class="mf">0.055</span><span class="p">)</span> <span class="o">/</span> <span class="mf">1.055</span><span class="p">,</span> <span class="mf">2.4</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">frame_data</span>
</pre></div>

        </details>

            <div class="docstring"><p>Inverse sRGB electro-optical transfer function</p>

<h6 id="args">Args</h6>

<ul>
<li><strong>frame_data:</strong>  pixel values expected in the range [0, 1]</li>
</ul>

<h6 id="returns">Returns</h6>

<blockquote>
  <p>frame_data: pixel values in the range [0, 1]</p>
</blockquote>
</div>


                            </div>
                            <div id="SiTiCalculator.apply_display_model" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#SiTiCalculator.apply_display_model">#&nbsp;&nbsp</a>

                <div class="decorator">@staticmethod</div>

            <span class="def">def</span>
            <span class="name">apply_display_model</span><span class="signature">(
    frame_data: numpy.ndarray,
    eotf_function: <a href="#EotfFunction">siti_tools.siti.EotfFunction</a> = &lt;<a href="#EotfFunction.BT1886">EotfFunction.BT1886</a>: &#39;bt1886&#39;&gt;,
    l_max: float = 300,
    l_min: float = 0.1,
    gamma: float = 2.4
) -&gt; numpy.ndarray</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">apply_display_model</span><span class="p">(</span>
        <span class="n">frame_data</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
        <span class="n">eotf_function</span><span class="p">:</span> <span class="n">EotfFunction</span> <span class="o">=</span> <span class="n">EotfFunction</span><span class="o">.</span><span class="n">BT1886</span><span class="p">,</span>
        <span class="n">l_max</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">DEFAULT_L_MAX</span><span class="p">,</span>
        <span class="n">l_min</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">DEFAULT_L_MIN</span><span class="p">,</span>
        <span class="n">gamma</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">DEFAULT_GAMMA</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Apply the SDR EOTF</span>

<span class="sd">        Args:</span>
<span class="sd">            frame_data (np.ndarray): Raw frame data in full range, values in the range [0, 1]</span>
<span class="sd">            Other arguments: see calculate()</span>

<span class="sd">        Returns:</span>
<span class="sd">            frame_data: pixel values in the physical domain.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">frame_data</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Input for apply_display_model() was &lt; 0&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">frame_data</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Input for apply_display_model() was &gt; 1&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">eotf_function</span> <span class="o">==</span> <span class="n">EotfFunction</span><span class="o">.</span><span class="n">BT1886</span><span class="p">:</span>
            <span class="n">fn</span> <span class="o">=</span> <span class="n">SiTiCalculator</span><span class="o">.</span><span class="n">eotf_1886</span>
            <span class="c1"># note that l_min/l_max are not passed here on purpose, as they are set to 0.0 and 1.0,</span>
            <span class="c1"># and mapped outside of the eotf_1886 function</span>
            <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;gamma&quot;</span><span class="p">:</span> <span class="n">gamma</span><span class="p">}</span>
        <span class="k">elif</span> <span class="n">eotf_function</span> <span class="o">==</span> <span class="n">EotfFunction</span><span class="o">.</span><span class="n">INV_SRGB</span><span class="p">:</span>
            <span class="n">fn</span> <span class="o">=</span> <span class="n">SiTiCalculator</span><span class="o">.</span><span class="n">eotf_inv_srgb</span>
            <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Unknown EOTF function!&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">(</span><span class="n">l_max</span> <span class="o">-</span> <span class="n">l_min</span><span class="p">)</span> <span class="o">*</span> <span class="n">fn</span><span class="p">(</span><span class="n">frame_data</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">+</span> <span class="n">l_min</span>
</pre></div>

        </details>

            <div class="docstring"><p>Apply the SDR EOTF</p>

<h6 id="args">Args</h6>

<ul>
<li><strong>frame_data (np.ndarray):</strong>  Raw frame data in full range, values in the range [0, 1]</li>
<li><strong>Other arguments:</strong>  see calculate()</li>
</ul>

<h6 id="returns">Returns</h6>

<blockquote>
  <p>frame_data: pixel values in the physical domain.</p>
</blockquote>
</div>


                            </div>
                            <div id="SiTiCalculator.oetf_pq" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#SiTiCalculator.oetf_pq">#&nbsp;&nbsp</a>

                <div class="decorator">@staticmethod</div>

            <span class="def">def</span>
            <span class="name">oetf_pq</span><span class="signature">(frame_data: numpy.ndarray) -&gt; numpy.ndarray</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">oetf_pq</span><span class="p">(</span><span class="n">frame_data</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Perceptual quantizer opto-electrical transfer function defined in ITU-R Rec. BT.2100</span>

<span class="sd">        Args:</span>
<span class="sd">            frame_data: pixel values expected to be in the physical luminance between 0 and 10,000 cd/m^2</span>

<span class="sd">        Returns:</span>
<span class="sd">            frame_data: pixel values in the range [0, 1]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">m</span> <span class="o">=</span> <span class="mf">78.84375</span>
        <span class="n">n</span> <span class="o">=</span> <span class="mf">0.1593017578125</span>
        <span class="n">c1</span> <span class="o">=</span> <span class="mf">0.8359375</span>
        <span class="n">c2</span> <span class="o">=</span> <span class="mf">18.8515625</span>
        <span class="n">c3</span> <span class="o">=</span> <span class="mf">18.6875</span>
        <span class="n">lm1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="mf">10000.0</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
        <span class="c1"># FIXME: this might return an error if input is negative, see https://stackoverflow.com/q/45384602/</span>
        <span class="n">lm2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">frame_data</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>

        <span class="n">frame_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">((</span><span class="n">c1</span> <span class="o">*</span> <span class="n">lm1</span> <span class="o">+</span> <span class="n">c2</span> <span class="o">*</span> <span class="n">lm2</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">lm1</span> <span class="o">+</span> <span class="n">c3</span> <span class="o">*</span> <span class="n">lm2</span><span class="p">),</span> <span class="n">m</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">frame_data</span>
</pre></div>

        </details>

            <div class="docstring"><p>Perceptual quantizer opto-electrical transfer function defined in ITU-R Rec. BT.2100</p>

<h6 id="args">Args</h6>

<ul>
<li><strong>frame_data:</strong>  pixel values expected to be in the physical luminance between 0 and 10,000 cd/m^2</li>
</ul>

<h6 id="returns">Returns</h6>

<blockquote>
  <p>frame_data: pixel values in the range [0, 1]</p>
</blockquote>
</div>


                            </div>
                            <div id="SiTiCalculator.oetf_pu21" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#SiTiCalculator.oetf_pu21">#&nbsp;&nbsp</a>

                <div class="decorator">@staticmethod</div>

            <span class="def">def</span>
            <span class="name">oetf_pu21</span><span class="signature">(
    frame_data: numpy.ndarray,
    mode: <a href="#Pu21Mode">siti_tools.siti.Pu21Mode</a> = &lt;<a href="#Pu21Mode.BANDING">Pu21Mode.BANDING</a>: &#39;banding&#39;&gt;
) -&gt; numpy.ndarray</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">oetf_pu21</span><span class="p">(</span>
        <span class="n">frame_data</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
        <span class="n">mode</span><span class="p">:</span> <span class="n">Pu21Mode</span> <span class="o">=</span> <span class="n">Pu21Mode</span><span class="o">.</span><span class="n">BANDING</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        PU21 OETF, see https://github.com/gfxdisp/pu21</span>

<span class="sd">        Args:</span>
<span class="sd">            frame_data (np.ndarray): Raw frame data in full range, values in the range [0, 1]</span>
<span class="sd">            mode (Pu21Mode), defaults to Pu21Mode.BANDING</span>

<span class="sd">        Returns:</span>
<span class="sd">            frame_data: pixel values in the range [0, 1]</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;banding&quot;</span><span class="p">:</span>
            <span class="n">p</span> <span class="o">=</span> <span class="p">[</span>
                <span class="mf">1.070275272</span><span class="p">,</span>
                <span class="mf">0.4088273932</span><span class="p">,</span>
                <span class="mf">0.153224308</span><span class="p">,</span>
                <span class="mf">0.2520326168</span><span class="p">,</span>
                <span class="mf">1.063512885</span><span class="p">,</span>
                <span class="mf">1.14115047</span><span class="p">,</span>
                <span class="mf">521.4527484</span><span class="p">,</span>
            <span class="p">]</span>
            <span class="n">p_min</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.5580e-07</span>
            <span class="n">p_max</span> <span class="o">=</span> <span class="mf">520.4673</span>
        <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;banding_glare&quot;</span><span class="p">:</span>
            <span class="n">p</span> <span class="o">=</span> <span class="p">[</span>
                <span class="mf">0.353487901</span><span class="p">,</span>
                <span class="mf">0.3734658629</span><span class="p">,</span>
                <span class="mf">8.277049286e-05</span><span class="p">,</span>
                <span class="mf">0.9062562627</span><span class="p">,</span>
                <span class="mf">0.09150303166</span><span class="p">,</span>
                <span class="mf">0.9099517204</span><span class="p">,</span>
                <span class="mf">596.3148142</span><span class="p">,</span>
            <span class="p">]</span>
            <span class="n">p_min</span> <span class="o">=</span> <span class="mf">5.4705e-10</span>
            <span class="n">p_max</span> <span class="o">=</span> <span class="mf">595.3939</span>
        <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;peaks&quot;</span><span class="p">:</span>
            <span class="n">p</span> <span class="o">=</span> <span class="p">[</span>
                <span class="mf">1.043882782</span><span class="p">,</span>
                <span class="mf">0.6459495343</span><span class="p">,</span>
                <span class="mf">0.3194584211</span><span class="p">,</span>
                <span class="mf">0.374025247</span><span class="p">,</span>
                <span class="mf">1.114783422</span><span class="p">,</span>
                <span class="mf">1.095360363</span><span class="p">,</span>
                <span class="mf">384.9217577</span><span class="p">,</span>
            <span class="p">]</span>
            <span class="n">p_min</span> <span class="o">=</span> <span class="mf">1.3674e-07</span>
            <span class="n">p_max</span> <span class="o">=</span> <span class="mf">380.9853</span>
        <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;peaks_glare&quot;</span><span class="p">:</span>
            <span class="n">p</span> <span class="o">=</span> <span class="p">[</span>
                <span class="mf">816.885024</span><span class="p">,</span>
                <span class="mf">1479.463946</span><span class="p">,</span>
                <span class="mf">0.001253215609</span><span class="p">,</span>
                <span class="mf">0.9329636822</span><span class="p">,</span>
                <span class="mf">0.06746643971</span><span class="p">,</span>
                <span class="mf">1.573435413</span><span class="p">,</span>
                <span class="mf">419.6006374</span><span class="p">,</span>
            <span class="p">]</span>
            <span class="n">p_min</span> <span class="o">=</span> <span class="o">-</span><span class="mf">9.7360e-08</span>
            <span class="n">p_max</span> <span class="o">=</span> <span class="mf">407.5066</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Invalid mode specified for PU21&quot;</span><span class="p">)</span>

        <span class="c1"># scale frame_data to the range 0.005 - 10,000</span>
        <span class="c1"># disabled since the input is already in physical luminance</span>
        <span class="c1"># frame_data = frame_data * 10000.0</span>
        <span class="c1"># frame_data = np.maximum(frame_data, 0.05)</span>

        <span class="n">frame_data</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span>
                <span class="p">(</span>
                    <span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">frame_data</span><span class="p">,</span> <span class="n">p</span><span class="p">[</span><span class="mi">3</span><span class="p">]))</span>
                    <span class="o">/</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="n">p</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">frame_data</span><span class="p">,</span> <span class="n">p</span><span class="p">[</span><span class="mi">3</span><span class="p">]))</span>
                <span class="p">),</span>
                <span class="n">p</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span>
            <span class="p">)</span>
            <span class="o">-</span> <span class="n">p</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>
        <span class="p">)</span>

        <span class="c1"># get the output into the range [0, 1]</span>
        <span class="n">frame_data</span> <span class="o">=</span> <span class="p">(</span><span class="n">frame_data</span> <span class="o">-</span> <span class="n">p_min</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">p_max</span> <span class="o">-</span> <span class="n">p_min</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">frame_data</span>
</pre></div>

        </details>

            <div class="docstring"><p>PU21 OETF, see https://github.com/gfxdisp/pu21</p>

<h6 id="args">Args</h6>

<ul>
<li><strong>frame_data (np.ndarray):</strong>  Raw frame data in full range, values in the range [0, 1]</li>
<li>mode (Pu21Mode), defaults to <a href="#Pu21Mode.BANDING">Pu21Mode.BANDING</a></li>
</ul>

<h6 id="returns">Returns</h6>

<blockquote>
  <p>frame_data: pixel values in the range [0, 1]</p>
</blockquote>
</div>


                            </div>
                            <div id="SiTiCalculator.eotf_hlg" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#SiTiCalculator.eotf_hlg">#&nbsp;&nbsp</a>

                <div class="decorator">@staticmethod</div>

            <span class="def">def</span>
            <span class="name">eotf_hlg</span><span class="signature">(
    frame_data: numpy.ndarray,
    l_min: float = 0.01,
    l_max: float = 1000.0
) -&gt; numpy.ndarray</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">eotf_hlg</span><span class="p">(</span>
        <span class="n">frame_data</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
        <span class="n">l_min</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">DEFAULT_L_MIN_HDR</span><span class="p">,</span>
        <span class="n">l_max</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">DEFAULT_L_MAX_HDR</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Hybrid log-gamma opto-electrical transfer function defined in ITU-T Rec. BT.2100</span>

<span class="sd">        Args:</span>
<span class="sd">            frame_data: pixel values expected to be in the range [0, 1]</span>

<span class="sd">        Returns:</span>
<span class="sd">            frame_data: pixel values in the physical luminance up to 10,000 cd/m^2</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">frame_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">frame_data</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
        <span class="n">frame_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">frame_data</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>

        <span class="n">a</span> <span class="o">=</span> <span class="mf">0.17883277</span>
        <span class="n">b</span> <span class="o">=</span> <span class="mf">0.02372241</span>
        <span class="n">c</span> <span class="o">=</span> <span class="mf">1.00429347</span>
        <span class="n">gamma</span> <span class="o">=</span> <span class="mf">1.2</span>

        <span class="n">frame_data</span> <span class="o">=</span> <span class="p">(</span><span class="n">frame_data</span> <span class="o">&lt;=</span> <span class="mf">0.5</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">frame_data</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">)</span> <span class="o">/</span> <span class="mf">3.0</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span>
            <span class="n">frame_data</span> <span class="o">&gt;</span> <span class="mf">0.5</span>
        <span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">((</span><span class="n">frame_data</span> <span class="o">-</span> <span class="n">c</span><span class="p">)</span> <span class="o">/</span> <span class="n">a</span><span class="p">)</span> <span class="o">-</span> <span class="n">b</span><span class="p">)</span>

        <span class="n">frame_data</span> <span class="o">=</span> <span class="p">(</span><span class="n">l_max</span> <span class="o">-</span> <span class="n">l_min</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">frame_data</span><span class="p">,</span> <span class="n">gamma</span> <span class="o">-</span> <span class="mf">1.0</span><span class="p">)</span> <span class="o">+</span> <span class="n">l_min</span>

        <span class="k">return</span> <span class="n">frame_data</span>
</pre></div>

        </details>

            <div class="docstring"><p>Hybrid log-gamma opto-electrical transfer function defined in ITU-T Rec. BT.2100</p>

<h6 id="args">Args</h6>

<ul>
<li><strong>frame_data:</strong>  pixel values expected to be in the range [0, 1]</li>
</ul>

<h6 id="returns">Returns</h6>

<blockquote>
  <p>frame_data: pixel values in the physical luminance up to 10,000 cd/m^2</p>
</blockquote>
</div>


                            </div>
                            <div id="SiTiCalculator.normalize_to_original_range" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#SiTiCalculator.normalize_to_original_range">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">normalize_to_original_range</span><span class="signature">(self, frame_data: Union[numpy.ndarray, float])</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">normalize_to_original_range</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frame_data</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="nb">float</span><span class="p">]):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Normalize frame data in the range [0, 1] to their original range, based on</span>
<span class="sd">        bit depth, e.g. from [0, 1] to [0, 255].</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">frame_data</span> <span class="o">*</span> <span class="p">(</span><span class="mi">2</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">bit_depth</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
</pre></div>

        </details>

            <div class="docstring"><p>Normalize frame data in the range [0, 1] to their original range, based on
bit depth, e.g. from [0, 1] to [0, 255].</p>
</div>


                            </div>
                            <div id="SiTiCalculator.normalize_to_original_si_range" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#SiTiCalculator.normalize_to_original_si_range">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">normalize_to_original_si_range</span><span class="signature">(self, frame_data: Union[numpy.ndarray, float])</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">normalize_to_original_si_range</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frame_data</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="nb">float</span><span class="p">]):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Normalize frame data in the range [0, 1] to [0, 255], which was the original</span>
<span class="sd">        range for SI/TI.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">frame_data</span> <span class="o">*</span> <span class="p">(</span><span class="mi">2</span><span class="o">**</span><span class="mi">8</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
</pre></div>

        </details>

            <div class="docstring"><p>Normalize frame data in the range [0, 1] to [0, 255], which was the original
range for SI/TI.</p>
</div>


                            </div>
                            <div id="SiTiCalculator.normalize_between_0_1" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#SiTiCalculator.normalize_between_0_1">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">normalize_between_0_1</span><span class="signature">(self, frame_data: Union[numpy.ndarray, float])</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">normalize_between_0_1</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frame_data</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="nb">float</span><span class="p">]):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Normalize frame data in the range [0, x] to [0, 1], based on bit depth.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">frame_data</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">bit_depth</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
</pre></div>

        </details>

            <div class="docstring"><p>Normalize frame data in the range [0, x] to [0, 1], based on bit depth.</p>
</div>


                            </div>
                            <div id="SiTiCalculator.add_frame_callback" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#SiTiCalculator.add_frame_callback">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">add_frame_callback</span><span class="signature">(self, callback_fn: Callable[[float, Optional[float], int], NoneType])</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">add_frame_callback</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">callback_fn</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">float</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="kc">None</span><span class="p">],</span> <span class="nb">int</span><span class="p">],</span> <span class="kc">None</span><span class="p">]</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add a function that gets called whenever a frame&#39;s values are available</span>

<span class="sd">        Args:</span>
<span class="sd">            callback_fn (Callable[[float, Union[float, None], int], None]): The function that should get called. It will receive SI, TI and the frame number.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">callbacks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">callback_fn</span><span class="p">)</span>
</pre></div>

        </details>

            <div class="docstring"><p>Add a function that gets called whenever a frame's values are available</p>

<h6 id="args">Args</h6>

<ul>
<li><strong>callback_fn (Callable[[float, Union[float, None], int], None]):</strong>  The function that should get called. It will receive SI, TI and the frame number.</li>
</ul>
</div>


                            </div>
                            <div id="SiTiCalculator.handle_limited_range" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#SiTiCalculator.handle_limited_range">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">handle_limited_range</span><span class="signature">(self, frame_data) -&gt; numpy.ndarray</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">handle_limited_range</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frame_data</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Transforms data from limited range to full range. We expect the input to be in [16/255, 235/255] already.</span>
<span class="sd">        Apply this to limited range content only! If we exceed the limited range, an error will be raised.</span>

<span class="sd">        Args:</span>
<span class="sd">            frame_data (np.ndarray): The frame data in limited range.</span>

<span class="sd">        Returns:</span>
<span class="sd">            frame_data: The frame data in full range between [0, 1].</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">input_min</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">frame_data</span><span class="p">)</span>
        <span class="n">input_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">frame_data</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">input_min</span> <span class="o">+</span> <span class="mf">0.001</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">LIMITED_RANGE_MIN</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span>
            <span class="n">input_max</span> <span class="o">-</span> <span class="mf">0.001</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">LIMITED_RANGE_MAX</span>
        <span class="p">):</span>
            <span class="c1"># inform the user about the original range</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                <span class="s2">&quot;Input appears to be full range, but it is treated as limited range SDR! &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;Input range is [</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">normalize_to_original_range</span><span class="p">(</span><span class="n">input_min</span><span class="p">))</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">normalize_to_original_range</span><span class="p">(</span><span class="n">input_max</span><span class="p">))</span><span class="si">}</span><span class="s2">]. &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;Expected range for limited content [</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">normalize_to_original_range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">LIMITED_RANGE_MIN</span><span class="p">))</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">normalize_to_original_range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">LIMITED_RANGE_MAX</span><span class="p">))</span><span class="si">}</span><span class="s2">]. &quot;</span>
                <span class="s2">&quot;Specify the range as full instead.&quot;</span>
            <span class="p">)</span>
        <span class="c1"># scale up to full range</span>
        <span class="n">frame_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span>
            <span class="p">(</span><span class="n">frame_data</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">LIMITED_RANGE_MIN</span><span class="p">)</span>
            <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">LIMITED_RANGE_MAX</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">LIMITED_RANGE_MIN</span><span class="p">),</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">frame_data</span>
</pre></div>

        </details>

            <div class="docstring"><p>Transforms data from limited range to full range. We expect the input to be in [16/255, 235/255] already.
Apply this to limited range content only! If we exceed the limited range, an error will be raised.</p>

<h6 id="args">Args</h6>

<ul>
<li><strong>frame_data (np.ndarray):</strong>  The frame data in limited range.</li>
</ul>

<h6 id="returns">Returns</h6>

<blockquote>
  <p>frame_data: The frame data in full range between [0, 1].</p>
</blockquote>
</div>


                            </div>
                            <div id="SiTiCalculator.plot_histogram" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#SiTiCalculator.plot_histogram">#&nbsp;&nbsp</a>

                <div class="decorator">@staticmethod</div>

            <span class="def">def</span>
            <span class="name">plot_histogram</span><span class="signature">(frame_data: numpy.ndarray) -&gt; str</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">plot_histogram</span><span class="p">(</span><span class="n">frame_data</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">plotille</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span>
            <span class="n">frame_data</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">bins</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">78</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span> <span class="n">x_min</span><span class="o">=</span><span class="mi">0</span>
        <span class="p">)</span>
</pre></div>

        </details>

    

                            </div>
                            <div id="SiTiCalculator.calculate" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#SiTiCalculator.calculate">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">calculate</span><span class="signature">(
    self,
    input_file: str,
    num_frames=0
) -&gt; Tuple[List[float], List[Optional[float]], int]</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">calculate</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">input_file</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">num_frames</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span> <span class="n">List</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="kc">None</span><span class="p">]],</span> <span class="nb">int</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Calculate SI and TI from an input file.</span>

<span class="sd">        Returns two arrays and one integer, the first array being the SI values, the</span>
<span class="sd">        second array being the TI values. The first element of the TI value array will</span>
<span class="sd">        always be 0. The integer will be equal to the number of frames read.</span>

<span class="sd">        You can also get the results later via .get_results()</span>

<span class="sd">        Args:</span>
<span class="sd">            input_file (str): input file path</span>
<span class="sd">            num_frames (int): number of frames to calculate. Defaults to 0 (unlimited).</span>

<span class="sd">        Returns:</span>
<span class="sd">            [[float], [float|None], int]: [si_values], [ti_values], frame count</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">si_values</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ti_values</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">last_input_file</span> <span class="o">=</span> <span class="n">input_file</span>
        <span class="n">previous_frame_data</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">current_frame</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">frame_data</span> <span class="ow">in</span> <span class="n">read_container</span><span class="p">(</span><span class="n">input_file</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="ow">and</span> <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Frame </span><span class="si">{</span><span class="n">current_frame</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">current_frame</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Original frame data&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_log_frame_data</span><span class="p">(</span><span class="n">frame_data</span><span class="p">)</span>

            <span class="c1"># Normalize frame data according to bit depth between 0 and 1.</span>
            <span class="c1"># This will transform [0, 255] to [0, 1], and [0, 1023] to [0, 1] etc.</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">legacy</span><span class="p">:</span>
                <span class="n">frame_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">normalize_between_0_1</span><span class="p">(</span><span class="n">frame_data</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">current_frame</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Frame data after normalization between 0 and 1&quot;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_log_frame_data</span><span class="p">(</span><span class="n">frame_data</span><span class="p">)</span>

                <span class="c1"># convert limited to full range</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">color_range</span> <span class="o">==</span> <span class="n">ColorRange</span><span class="o">.</span><span class="n">LIMITED</span><span class="p">:</span>
                    <span class="n">frame_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">handle_limited_range</span><span class="p">(</span><span class="n">frame_data</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">current_frame</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Frame data after limited-range normalization&quot;</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_log_frame_data</span><span class="p">(</span><span class="n">frame_data</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># in full range, we do not have to further process the data</span>
                    <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">color_range</span> <span class="o">==</span> <span class="n">ColorRange</span><span class="o">.</span><span class="n">LIMITED</span><span class="p">:</span>
                    <span class="c1"># legacy mode, apply the old way of normalizing data between 16-235</span>
                    <span class="n">input_min</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">frame_data</span><span class="p">)</span>
                    <span class="n">input_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">frame_data</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">input_min</span> <span class="o">&lt;</span> <span class="mi">16</span> <span class="ow">or</span> <span class="n">input_max</span> <span class="o">&gt;</span> <span class="mi">235</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;Input appears to be full range ([</span><span class="si">{</span><span class="n">input_min</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">input_max</span><span class="si">}</span><span class="s2">]), specify --color-range=full!&quot;</span>
                        <span class="p">)</span>
                    <span class="c1"># convert to grey by assumng limited range input</span>
                    <span class="n">frame_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">((</span><span class="n">frame_data</span> <span class="o">-</span> <span class="mi">16</span><span class="p">)</span> <span class="o">/</span> <span class="p">((</span><span class="mi">235</span> <span class="o">-</span> <span class="mi">16</span><span class="p">)</span> <span class="o">/</span> <span class="mi">255</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># in full range, we do not have to further process the data</span>
                    <span class="k">pass</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">legacy</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hdr_mode</span> <span class="o">==</span> <span class="n">HdrMode</span><span class="o">.</span><span class="n">SDR</span><span class="p">:</span>
                    <span class="n">frame_data</span> <span class="o">=</span> <span class="n">SiTiCalculator</span><span class="o">.</span><span class="n">apply_display_model</span><span class="p">(</span>
                        <span class="n">frame_data</span><span class="p">,</span>
                        <span class="n">eotf_function</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">eotf_function</span><span class="p">,</span>
                        <span class="n">l_max</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">l_max</span><span class="p">,</span>
                        <span class="n">l_min</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">l_min</span><span class="p">,</span>
                        <span class="n">gamma</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gamma</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="k">if</span> <span class="n">current_frame</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;Frame data after apply_display_model for SDR (</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">l_min</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">l_max</span><span class="si">}</span><span class="s2">)&quot;</span>
                        <span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_log_frame_data</span><span class="p">(</span><span class="n">frame_data</span><span class="p">)</span>
                    <span class="n">frame_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">oetf_function</span><span class="p">(</span>
                        <span class="n">frame_data</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">oetf_function_kwargs</span>
                    <span class="p">)</span>
                    <span class="k">if</span> <span class="n">current_frame</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;Frame data after OETF function </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">oetf_function</span><span class="si">}</span><span class="s2"> with args </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">oetf_function_kwargs</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_log_frame_data</span><span class="p">(</span><span class="n">frame_data</span><span class="p">)</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">hdr_mode</span> <span class="o">==</span> <span class="n">HdrMode</span><span class="o">.</span><span class="n">HDR10</span><span class="p">:</span>
                    <span class="c1"># nothing to do, we are already in PQ domain</span>
                    <span class="c1"># TODO allow using Pu21 here?</span>
                    <span class="k">pass</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">hdr_mode</span> <span class="o">==</span> <span class="n">HdrMode</span><span class="o">.</span><span class="n">HLG</span><span class="p">:</span>
                    <span class="n">frame_data</span> <span class="o">=</span> <span class="n">SiTiCalculator</span><span class="o">.</span><span class="n">eotf_hlg</span><span class="p">(</span>
                        <span class="n">frame_data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">l_min</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">l_max</span>
                    <span class="p">)</span>
                    <span class="k">if</span> <span class="n">current_frame</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;Frame data after eotf_hlg for HLG with l_min/l_max settings </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">l_min</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">l_max</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_log_frame_data</span><span class="p">(</span><span class="n">frame_data</span><span class="p">)</span>
                    <span class="n">frame_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">oetf_function</span><span class="p">(</span>
                        <span class="n">frame_data</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">oetf_function_kwargs</span>
                    <span class="p">)</span>
                    <span class="k">if</span> <span class="n">current_frame</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;Frame data after OETF function </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">oetf_function</span><span class="si">}</span><span class="s2"> with args </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">oetf_function_kwargs</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_log_frame_data</span><span class="p">(</span><span class="n">frame_data</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid HDR mode &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">hdr_mode</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">legacy</span><span class="p">:</span>
                <span class="n">si_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">normalize_to_original_si_range</span><span class="p">(</span>
                    <span class="n">SiTiCalculator</span><span class="o">.</span><span class="n">si</span><span class="p">(</span><span class="n">frame_data</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">si_value</span> <span class="o">=</span> <span class="n">SiTiCalculator</span><span class="o">.</span><span class="n">si</span><span class="p">(</span><span class="n">frame_data</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">current_frame</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">legacy</span><span class="p">:</span>
                    <span class="n">ti_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">normalize_to_original_si_range</span><span class="p">(</span>
                        <span class="n">cast</span><span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="n">SiTiCalculator</span><span class="o">.</span><span class="n">ti</span><span class="p">(</span><span class="n">frame_data</span><span class="p">,</span> <span class="n">previous_frame_data</span><span class="p">))</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">ti_value</span> <span class="o">=</span> <span class="n">SiTiCalculator</span><span class="o">.</span><span class="n">ti</span><span class="p">(</span><span class="n">frame_data</span><span class="p">,</span> <span class="n">previous_frame_data</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ti_value</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;SI value </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="n">SiTiCalculator</span><span class="o">.</span><span class="n">si</span><span class="p">(</span><span class="n">frame_data</span><span class="p">),</span> <span class="mi">3</span><span class="p">)</span><span class="si">}</span><span class="s2">, normalized: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">normalize_to_original_si_range</span><span class="p">(</span><span class="n">SiTiCalculator</span><span class="o">.</span><span class="n">si</span><span class="p">(</span><span class="n">frame_data</span><span class="p">)),</span> <span class="mi">3</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">ti_value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;TI value </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="n">cast</span><span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="n">SiTiCalculator</span><span class="o">.</span><span class="n">ti</span><span class="p">(</span><span class="n">frame_data</span><span class="p">,</span> <span class="n">previous_frame_data</span><span class="p">)),</span> <span class="mi">3</span><span class="p">)</span><span class="si">}</span><span class="s2">, normalized: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">normalize_to_original_si_range</span><span class="p">(</span><span class="n">cast</span><span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="n">SiTiCalculator</span><span class="o">.</span><span class="n">ti</span><span class="p">(</span><span class="n">frame_data</span><span class="p">,</span> <span class="n">previous_frame_data</span><span class="p">))),</span> <span class="mi">3</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">si_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cast</span><span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="n">si_value</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">ti_value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ti_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cast</span><span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="n">ti_value</span><span class="p">))</span>

            <span class="n">previous_frame_data</span> <span class="o">=</span> <span class="n">frame_data</span>

            <span class="n">current_frame</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="k">for</span> <span class="n">callback</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">callbacks</span><span class="p">:</span>
                <span class="n">callback</span><span class="p">(</span><span class="n">si_value</span><span class="p">,</span> <span class="n">ti_value</span><span class="p">,</span> <span class="n">current_frame</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">num_frames</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="ow">and</span> <span class="n">current_frame</span> <span class="o">&gt;=</span> <span class="n">num_frames</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">si_values</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ti_values</span><span class="p">,</span> <span class="n">current_frame</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">si_values</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ti_values</span><span class="p">,</span> <span class="n">current_frame</span>
</pre></div>

        </details>

            <div class="docstring"><p>Calculate SI and TI from an input file.</p>

<p>Returns two arrays and one integer, the first array being the SI values, the
second array being the TI values. The first element of the TI value array will
always be 0. The integer will be equal to the number of frames read.</p>

<p>You can also get the results later via .get_results()</p>

<h6 id="args">Args</h6>

<ul>
<li><strong>input_file (str):</strong>  input file path</li>
<li><strong>num_frames (int):</strong>  number of frames to calculate. Defaults to 0 (unlimited).</li>
</ul>

<h6 id="returns">Returns</h6>

<blockquote>
  <p>[[float], [float|None], int]: [si_values], [ti_values], frame count</p>
</blockquote>
</div>


                            </div>
                            <div id="SiTiCalculator.get_csv_results" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#SiTiCalculator.get_csv_results">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">get_csv_results</span><span class="signature">(self) -&gt; str</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">get_csv_results</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a CSV string with the results.</span>

<span class="sd">        Note that this does not output all data. Also, the first TI value will be output as &quot;None&quot;.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># prepend a zero here</span>
        <span class="n">ti_values_to_output</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">ti_values</span><span class="p">]</span>

        <span class="n">output</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">StringIO</span><span class="p">()</span>
        <span class="n">writer</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">DictWriter</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="n">fieldnames</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;input_file&quot;</span><span class="p">,</span> <span class="s2">&quot;n&quot;</span><span class="p">,</span> <span class="s2">&quot;si&quot;</span><span class="p">,</span> <span class="s2">&quot;ti&quot;</span><span class="p">])</span>
        <span class="n">writer</span><span class="o">.</span><span class="n">writeheader</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="p">(</span><span class="n">si_value</span><span class="p">,</span> <span class="n">ti_value</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span>
            <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">si_values</span><span class="p">,</span> <span class="n">ti_values_to_output</span><span class="p">)</span>
        <span class="p">):</span>
            <span class="n">writer</span><span class="o">.</span><span class="n">writerow</span><span class="p">(</span>
                <span class="p">{</span>
                    <span class="s2">&quot;input_file&quot;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">last_input_file</span><span class="p">)</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_input_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                    <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;n&quot;</span><span class="p">:</span> <span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
                    <span class="s2">&quot;si&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">si_value</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>
                    <span class="s2">&quot;ti&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">ti_value</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="k">if</span> <span class="n">ti_value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
                <span class="p">}</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">output</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()</span>
</pre></div>

        </details>

            <div class="docstring"><p>Return a CSV string with the results.</p>

<p>Note that this does not output all data. Also, the first TI value will be output as "None".</p>
</div>


                            </div>
                            <div id="SiTiCalculator.get_results" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#SiTiCalculator.get_results">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">get_results</span><span class="signature">(self) -&gt; Dict</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">get_results</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get a JSON-serializable result dictionary with SI, TI values, as well as used settings.</span>

<span class="sd">        Returns:</span>
<span class="sd">            dict: A dictionary containing &quot;si&quot;, &quot;ti&quot; arrays, &quot;settings&quot; as a dict, and the &quot;input_file&quot; name.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;si&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">si_values</span><span class="p">,</span>
            <span class="s2">&quot;ti&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">ti_values</span><span class="p">,</span>
            <span class="s2">&quot;settings&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_general_settings</span><span class="p">(),</span>
            <span class="s2">&quot;input_file&quot;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">last_input_file</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_input_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="p">}</span>
</pre></div>

        </details>

            <div class="docstring"><p>Get a JSON-serializable result dictionary with SI, TI values, as well as used settings.</p>

<h6 id="returns">Returns</h6>

<blockquote>
  <p>dict: A dictionary containing "si", "ti" arrays, "settings" as a dict, and the "input_file" name.</p>
</blockquote>
</div>


                            </div>
                </section>
    </main>
</body>
</html>